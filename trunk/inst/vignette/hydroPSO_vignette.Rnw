\documentclass[a4paper,12pt]{article}
%\documentclass[a4paper,12pt]{scrartcl}

\author{Rodrigo Rojas, PhD \\
        Mauricio Zambrano-Bigiarini, PhD}
%\pdfbookmark[0]{Titlepage}{title} % Sets a PDF bookmark for the title page

\title{Tutorial for interfacing \emph{hydroPSO} with SWAT-2005 and MODFLOW-2005}

\date{\today}

%\subtitle{for hydroPSO >= 0.2-0}

%\VignetteIndexEntry{Tutorial for interfacing \emph{hydroPSO} with SWAT-2005 and MODFLOW-2005}
%\VignetteKeyword{}
%\VignetteKeyword{}

\usepackage{Sweave}
\usepackage{natbib}
\usepackage{doipubmed}
\usepackage{url}
\usepackage{graphicx}
\usepackage{graphics}
\usepackage{booktabs}
\usepackage{fancyvrb}
\usepackage{multicol}
\usepackage{multirow}
\usepackage{amssymb,amsmath}
\usepackage[ruled]{algorithm}
\usepackage[noend]{algorithmic}
\usepackage{threeparttable}
\usepackage{rotating}
%%\usepackage[hidelinks]{hyperref}
\usepackage[colorlinks=true,linkcolor=black,citecolor=blue,urlcolor=blue]{hyperref}
\usepackage{setspace}

\begin{document}

% The following 6 lines are necessary to avoid the following error: "Error in driver$finish(drobj) :  the output file 'MyDocument.tex' has disappeared". From: http://r.789695.n4.nabble.com/Sweave-problem-after-R-update-version-td4566044.html
\SweaveOpts{...}
<<Rsetup, echo=FALSE>>=
CUR_WD=getwd()
setwd(".")
options(width=80)
@ 

\maketitle

\clearpage

\tableofcontents

\clearpage

\addcontentsline{toc}{section}{List of Tables}
\listoftables

\clearpage

\addcontentsline{toc}{section}{List of Figures}
\listoffigures

\clearpage

\section*{Preface\label{sec:preface}}
\addcontentsline{toc}{section}{Preface}
The next tutorial shows how to use the \emph{hydroPSO} R package to calibrate different model codes. Two of the main properties of \emph{hydroPSO} are the independence from the model to be calibrated and the simple interfacing between the model code and the calibration-engine, i.e. \emph{hydroPSO}. These two properties are illustrated through the calibration of real-world case studies, which should be the starting point for a user planning to implement \emph{hydroPSO} for her/his own model calibration exercise.

We show here how to use \emph{hydroPSO} to calibrate a semi-distributed hydrological model and a steady-state groundwater flow model. The first is fully implemented in SWAT-2005 \citep{neitsch+al2005a} whereas the second is implemented in MODFLOW-2005 (MF2005) \citep{mf2005}. Both model codes are widely-used programs to solve surface water and groundwater flow problems. At the same time, for illustrative purposes we use the program ZONEBUDGET (ZB) \citep{zonebudget} to obtain groundwater flows at particular aquifer cross sections. The purpose of including ZB is to illustrate how to interface \emph{hydroPSO} with a sequential modelling application. In this case, however, only MF2005 is calibrated against observed data and including other observations can be easily implemented in a similar way as described here. 

Both programs SWAT-2005 and MF2005/ZB are public domain and accessible from \url{http://swatmodel.tamu.edu/software/swat-model/} and \url{http://water.usgs.gov/nrp/gwsoftware/modflow.html}, respectively. For simplicity, we must assume some basic knowledge from part of the reader about the file naming convention used in SWAT-2005, MF2005/ZB, as well as the setting up of the internal options for these programs.

As an integral part of this tutorial, the reader can download from \url{http://www.rforge.net/hydroPSO/} two files \href{http://www.rforge.net/hydroPSO/files/MF2005.zip}{MF2005.zip} and \href{http://www.rforge.net/hydroPSO/files/SWAT2005.zip}{SWAT2005.zip} including all the required files to run SWAT-2005 and MF2005, sample R scripts to interface \emph{hydroPSO} with SWAT-2005 and MF2005, as well as several auxiliary files.

For assistance, bugs report, comments, and suggestions please contact the authors of the \emph{hydroPSO} package at:
\href{mailto:mzb.devel@gmail.com}{mzb.devel@gmail.com} and/or \href{mailto:Rodrigo.RojasMujica@gmail.com}{Rodrigo.RojasMujica@gmail.com}.

\clearpage

\section{Introduction\label{sec:intro}}
\emph{hydroPSO} is an R package implementing the Particle Swarm Optimisation (PSO) algorithm \citep{kennedyeberhart1995,eberhartkennedy1995}. PSO is a population-based stochastic optimisation technique inspired by social behaviour of bird flocking, which shares few similarities with other evolutionary optimisation techniques such as Genetic Algorithms (GA) \citep{poli+al2007}. In PSO, however, the solution-space is explored on the basis of individual and neighbourhood best-known ``particle positions'' with no presence of evolution operators (e.g. mutation or crossover) as in GA. PSO has recently received a surge of attention in literature given its flexibility, simplicity of implementation (programming), low memory and computational requirements, low number of adjustable parameters, and efficiency \citep[see, e.g.,][]{eberhartshi1998,shieberhart1999,eberhartshi2001,poli+al2007}.

The main motivations for developing the \emph{hydroPSO} package are: 
\begin{enumerate} 
\item bring this powerful optimisation/calibration technique to the attention of practitioners and scientists working on environmental modelling,  
\item provide a model-independent software package allowing the user to calibrate (different) environmental models without having to invest considerable programming efforts in customizing the calibration engine to the environmental model, and
\item allow the PSO research community to explore alternative advancements and configurations of the standard PSO using a versatile single-package software.
\end{enumerate}

Unlike other R packages recently developed for similar purposes (see e.g. \emph{hydromad}, \citealt{andrews+al2011}, \emph{R-SWAT-FME}, \citealt{wuliu2012}, and \emph{pso}, \citealt{psoptim2012}), \emph{hydroPSO} is not restricted to a limited number of hard-coded models, can be interfaced with any model with a relatively low programming effort, is fully compatible with calibration tools employing PEST-like template files \citep[see][]{pest2010}, and is easily parallelizable.

\emph{hydroPSO} is also capable of performing sensitivity analysis using the Latin Hypercube One-factor-At-a-Time (LH-OAT) method \citep[see][]{vangriensven+al2006} and provides detailed information about the evolution of PSO's performance. In addition, advanced plotting capabilities and a complete family of built-in functions contained in the R language \citep{R2011} are available to visualize and summarize the calibration results, respectively. At the same time, \emph{hydroPSO} features a suite of controlling options and PSO variants for fine-tuning and improving the performance of PSO, thus, allowing the user to adapt the calibration/optimisation engine to different modelling problems. For a full description of the PSO enhancements included in the \emph{hydroPSO} package the reader is referred to Section~\ref{sec:pso}.

In principle, \emph{hydroPSO} only needs to know \emph{which} model parameters need to be calibrated, \emph{where} they need to be written, and \emph{from where} and \emph{how} to read the main model output. Then, it will take control of the model(s) to be calibrated until either a maximum number of iterations or an error tolerance in the objective function are reached: these two being problem-specific and user-defined. The basic interaction between \emph{hydroPSO} and the model to be calibrated is shown in Figure~\ref{fig:f01vign}. For models with numerous input and output files or cascading models (i.e. serial modelling applications), several I/O functions can be combined to interface \emph{hydroPSO} and the model.

\begin{figure}
	\centering
	\noindent\includegraphics[width=0.5\textwidth]{./figures/f01vign.pdf} 
	\caption{Flow chart of the implementation/interaction between \emph{hydroPSO} and the model code to be calibrated. Dashed-line boxes represent basic I/O functions to read/write model files \citep[After][]{hydroPSO2012}.}
	\label{fig:f01vign}
\end{figure}

In this tutorial we show first how to interface \emph{hydroPSO} with SWAT-2005 \citep{neitsch+al2005a} to calibrate a semi-distributed hydrological model for the Ega River basin in Spain. That section illustrates three main points: 1) basic interfacing between \emph{hydroPSO} and the model through the definition of ASCII files \emph{ParamRanges.txt} and \emph{ParamFiles.txt}, 2) advanced sensitivity analysis using LH-OAT and the use of \emph{hydroPSO} pre-defined goodness-of-fit measures as objective functions, and 3) the set up for calibrating a model output variable in time and static in space (transient application). Second, we show how to interface \emph{hydroPSO} with MF2005 \citep{mf2005} to calibrate a groundwater flow model for the regional aquifer of the Pampa del Tamarugal basin in Chile. That section, in turn, illustrates: 1) advanced interfacing between \emph{hydroPSO} and the model through the implementation of user-defined I/O wrapper functions written in R, 2) how to define/use a customized goodness-of-fit measure as objective function, and 3) how to set up \emph{hydroPSO} for a model output fixed in time but variable in space (steady-state application). Details about both applications are summarized in Table~\ref{tab:table1}.

%%%%%%% TABLE1 
\begin{table}
 \caption{Distinctive features of the SWAT-2005 and MF2005 applications presented in this tutorial.}
 \label{tab:table1}
 \centering
 \resizebox{\textwidth}{!}{
\begin{tabular}{l l l}
\toprule
Application feature              & SWAT-2005                                 & MODFLOW-2005 \\
\midrule
OS                               & GNU/Linux                                 & Windows 7 \\
Type of model                    & Semi-distributed, surface hydrology       & Fully-distributed, groundwater \\
\emph{hydroPSO}-model interface  & Basic through ASCII files                 & Advanced through user-defined R functions \\
Executable model code            & Single file (swat2005.out)                & Sequential batch file (*.bat) \\
Simulated model outputs          & Transient (1962-1970), single observation & Steady-state (1960), multiple observations \\
Goodness-of-fit measure          & Pre-defined Nash-Sutcliffe efficiency     & User-defined Gaussian likelihood \\
\bottomrule
\end{tabular}
}
\end{table}
%%% END TABLE1 

We therefore believe that this tutorial cover two standard-problems commonly found by the modelling community. We must note, however, that these tutorials deal with surface water and groundwater modelling applications as these two are the authors' areas of expertise. However, based on the flexibility of the \emph{hydroPSO} package and the benefits added by programming it in R, we believe this package can be implemented to a wider range of environmental models requiring some form of parameter estimation. To the date of writing this tutorial, we have provided support to users calibrating models such as: SWAT-2005, MF2005, LISFLOOD, AGNPS, HBV-96, and SWIM.

In Section~\ref{sec:pso} we present a brief description of PSO, including the main algorithm, discussion on topologies and PSO variants and fine-tuning options available in \emph{hydroPSO}. Section~\ref{sec:package} briefly describes the main package functions as well as the basic requirements to interface \emph{hydroPSO} with a given model code. An introductory application of \emph{hydroPSO} to optimise test functions commonly used to assess the performance of optimisation algorithms is described in Section~\ref{sec:application}. The procedure to interface \emph{hydroPSO} with SWAT-2005 and MF2005 as well as the corresponding calibration results, are reported in Sections~\ref{sec:swat2005} and~\ref{sec:mf2005}, respectively.

\clearpage

\section{Particle Swarm Optimisation (PSO)\label{sec:pso}}
\subsection{Canonical PSO Algorithm\label{sec:psoalg}}
Particle Swarm Optimisation (PSO) is a population-based search algorithm developed by \citet{kennedyeberhart1995} and \citet{eberhartkennedy1995}. A feature distinguishing PSO from evolutionary algorithms is the lack of genetic operators, instead each individual of the population, termed \textit{particles} in PSO terminology, adjusts its \textit{flying trajectory} around the multi-dimensional search-space according to its own flying experience (\textit{local search}) and the one of all particles in the swarm (\textit{global search}) \citep{eberhartshi1998}.

Considering a $D$-dimensional search-space, \textit{position} and \textit{velocity} for the $i$-th particle are represented by $\vec{X}_i=x_{i1},x_{i2},\ldots,x_{iD}$ and $\vec{V}_i=v_{i1},v_{i2},\ldots,v_{iD}$, respectively. The performance of each particle is assessed through a problem-specific ``goodness-of-fit'' measure, which is the basis for calculating $\vec{X}_i$, thus, reflecting the quality of the particle's position. The best-known position of the $i$-th particle (known as \textit{personal best}) is represented by $\vec{P}_i=p_{i1},p_{i2},\ldots, p_{iD}$, whereas the best-known position for the whole swarm (known as \textit{local best}) is represented by $\vec{G}=g_{1},g_{2},\ldots, g_{D}$. Velocity and position of the $i$-th particle are updated according to the following equations,
  
\begin{equation}\label{eq:update1}
\vec{V}_{i}^{t+1} = \omega \vec{V}_{i}^t + c_1 \vec{U}_1^t \otimes (\vec{P}_{i}^t-\vec{X}_{i}^t) + c_2 \vec{U}_2^t \otimes (\vec{G}^t-\vec{X}_{i}^t)
\end{equation} 

\noindent or \citep{clerckennedy2002},

\begin{equation}\label{eq:update2}
\vec{V}_{i}^{t+1} = \chi \left[ \vec{V}_{i}^t + c_1 \vec{U}_1^t \otimes (\vec{P}_{i}^t-\vec{X}_{i}^t) + c_2 \vec{U}_2^t \otimes (\vec{G}^t-\vec{X}_{i}^t)\right]
\end{equation} 
  
\begin{equation}\label{eq:PositionUpdate}
\vec{X}_{i}^{t+1} = \vec{X}_{i}^t + \vec{V}_{i}^{t+1} 
\end{equation} 
  
\noindent where $i=1,2,\ldots,N$, with $N$ equal to the swarm size, and $t=1,2,\ldots,T$, with $T$ equal to the maximum number of iterations. $\omega$ is defined as the \emph{inertia weight}, which was introduced in early PSO variants to avoid particles flying around their best-known position without converging to it. $c_1$ and $c_2$ are the \emph{cognitive} and \emph{social} acceleration coefficients, which control the influence of the \emph{personal} and the \emph{local best}. These two parameters influence the trade-off between the \emph{local exploitation} and the \emph{global exploration} search abilities of the algorithm \citep{shieberhart1998b}. $\vec{U}_1$ and $\vec{U}_2$ are independent and uniformly distributed $D$-dimensional random vectors in the range $[0,1]$ used to maintain the ``diversity'' of the population (note that $\otimes$ denotes element-wise vector multiplication). $\chi$ is the constriction factor defined by

\begin{equation}\label{eq:clerccoeff}
\chi = \frac{2\kappa}{|2-\varphi-\sqrt{\varphi^{2}-4\varphi}|}
\end{equation} 

\noindent where $\kappa \in [0,1]$ and $\varphi = c_1 + c_2 > 4$, with typical values of $\kappa=1$, $c_1=c_2=2.05$ and $\varphi=4.1$. It should be noted that equations~\ref{eq:update1} and~\ref{eq:update2} are mathematically equivalent for appropriate values of the coefficients $\omega$, $c_1$, and $c_2$.

The inclusion of the inertia weight $(\omega)$ or the constriction factor $(\chi)$ in equations~\ref{eq:update1} or~\ref{eq:update2} aims to prevent \emph{swarm explosion}, i.e. an uncontrolled increase of the magnitude of velocities (particle displacement) \citep{poli+al2007}. In addition to this, \citet{eberhartshi2000} suggest constraining particle velocity to within the range $[-\vec{V}^{max},\vec{V}^{max}]$ with $\vec{V}^{max}=\vec{X}^{max}$, and $\vec{X}^{max}$ as the limits of the search space. In case this constraint is violated, the $d$-dimensional component of the velocity for the $i$-th particle is set directly to the closest velocity bound as follows

\begin{equation}\label{eq:PSOvmax}
v_{id} =  \left\{
  \begin{array}{r l r l}
     v^{max}_{d}  & , v_{id} > &  v^{max}_{d}  & \\ 
    -v^{max}_{d}  & , v_{id} < & -v^{max}_{d}  &
  \end{array} \right.
\end{equation}

Equations~\ref{eq:update1} to~\ref{eq:PSOvmax} can be considered as the canonical PSO algorithm \citep[see][]{kennedy2006}, which is summarised as follows

\begin{algorithm}[H]
\caption{Canonical PSO algorithm.}
 \begin{algorithmic}[1]
  \FOR[for each particle in the swarm]{$i=1$ to $N$}
   \STATE Initialize particles' positions $(\vec{X}_i)$ and velocities $(\vec{V}_i)$
   \STATE Initialize personal best, $\vec{P}_i$, and local best, $\vec{G}$
  \ENDFOR
  \REPEAT
   \FOR{$i=1$ to $N$}
    \STATE Pick random vectors $\vec{U}_1$ and $\vec{U}_2$
    \STATE Update particle's velocity using equations~\ref{eq:update1} or~\ref{eq:update2}
    \STATE Update particle's position using equation~\ref{eq:PositionUpdate}
     \IF[minimization of $f$]{$f(\vec{X}_i) < f(\vec{P}_i)$}
      \STATE Update particle's best-known position $\vec{P}_i=\vec{X}_i$
       \IF[minimization of $f$]{$f(\vec{P}_i) < f(\vec{G})$}
        \STATE Update the neighbourhood's best-known position $\vec{G}=\vec{P}_i$
       \ENDIF
     \ENDIF
   \ENDFOR
  \UNTIL[nr. of iterations $(T)$ or tolerance error is met]
 \end{algorithmic}
\end{algorithm}

\subsection{Topologies\label{ch:topologiesPSO}}
Particles in the swarm interact by defining a common set of links. These links control the exchange of information, i.e. they inform each particle of the best-known position of neighbouring particles, and are defined as the \emph{swarm topology}. The set of particles ``informing'' the $i$-th particle at the $t$-th iteration is termed the particle's \emph{neighbourhood}, and includes the particle itself as a member \citep{clerc2007}.

A vast number of swarm topologies has been investigated and reviewed in the literature \citep[see, e.g.,][]{kennedy1999, kennedymendes2002,kennedymendes2003,mendes2004,poli+al2007}. Two of the most common correspond to the so-called \emph{gbest} and \emph{lbest}. In the \emph{gbest} topology all particles are inter-connected and, thus, the best-known particle influences all the remaining particles in the swarm. This topology is generally recognised to have a fast convergence but is highly vulnerable to sub-optimal solutions and premature convergence \citep[see, e.g.,][]{mendes2004,clerc2006,poli+al2007}. In the \emph{lbest} topology, each particle is connected to two immediate neighbours and, thus, exchange of information with the best-known particle is restricted only to the particle's immediate neighbourhood. In general, the particle itself is included as a member of its neighbourhood \citep{mendes2004,clerc2006}. The \emph{lbest} topology shows the advantage of allowing parallel searches in different regions of the search-space \citep{poli+al2007}, which results in a more thorough search strategy. Accordingly, \emph{lbest} shows a slower convergence and less sensitivity to sub-optimal solutions compared to \emph{gbest}.

\citet{kennedymendes2002} investigate generalisations of the \emph{lbest} topology. One of their main findings is the relative superiority of the \emph{von Neumann} structured neighbourhood, i.e. four neighbours. This topology is more densely connected than \emph{lbest} but less densely connected than \emph{gbest}, thus, it shows some parallelism with \emph{lbest} but benefits from a larger neighbourhood \citep{poli+al2007}.

Finally, \citet{clerc2006} propose the so-called \emph{random} topology. In this topology, each particle informs $k$ particles (and itself) chosen randomly, with the parameter $k$ usually set to 3 \citep{clerc2012}. This results in each particle informing at least one (itself) and at most $k+1$ (including itself) particles, and being informed by any number of particles between 1 and $N$. The \emph{random} topology can be considered as a special case of the \emph{lbest} topology where particles have $k$ \emph{informants} most of the time and the ``connections'' between particles randomly change when the global optimum shows no improvement. The \emph{random} topology is used in the ``Standard PSO 2011'' algorithm, which has become the benchmark in recent years.

\subsection{PSO Variants and Fine-Tuning Options\label{sec:PSOvariants}}
Notwithstanding the inclusion of $V_{max}$ and $\omega$ aimed at overcoming premature convergence to sub-optimal solutions, improvements to the canonical PSO are still an active area of research \citep{poli+al2007}. To date, a vast collection of enhancements/variants has been suggested in the literature \citep[see, e.g.,][]{clerc2006,kennedy2006,vandenberghengelbrecht2006,zhao2006,poli+al2007,poli2008,chenchi2010}, resulting in a large group of algorithms, which we cannot fully review or implement into a single piece of software.

This section describes the PSO variants and state-of-the-art enhancements implemented in the calibration engine of \emph{hydroPSO}, which are further summarised in Table~\ref{tab:table2}.

\subsubsection{PSO Variants}
In equations~\ref{eq:update1} and~\ref{eq:update2} only two effective sources of ``influence`` are considered for updating the particles' velocities, namely, the position of the particle's personal best, $\vec{P}$, and the position of the local best, $\vec{G}$. \citet{mendes+al2004} propose a PSO variant, which they refer to as Fully Informed Particle Swarm (FIPS), where information drawn from all the particles in the neighbourhood (i.e. not only the best one) contributes to adjusting the particle's velocity. FIPS is implemented as follows,

\begin{equation}\label{eq:FIPS}
\vec{V}_{i}^{t+1} = \chi \left[ \vec{V}_{i}^t + \frac{1}{K_{i}} \sum_{n=1}^{K_{i}} \vec{U}_1^t(0,\varphi) \otimes (\vec{P}_{nbr_{n}}^t-\vec{X}_{i}^t) \right]
\end{equation} 

\noindent where $K_i$ is the number of neighbours for the $i$-th particle, and $\vec{P}_{nbr_{n}}$ is the position of the particle's $n$-th neighbour. Additionally, \citet{mendes+al2004} propose a second PSO variant, which they refer to as weighted FIPS (wFIPS). In wFIPS the contribution of each neighbour to the adjustment of a particle's velocity is weighted by the corresponding goodness-of-fit of its personal best. Performance of both FIPS and wFIPS is highly sensitive to the topology employed \citep{poli+al2007}, however, for topologies with few neighbours they outperform the canonical PSO algorithm \citep{mendes+al2004,kennedy2006}.

A third PSO variant implemented in \emph{hydroPSO} corresponds to the Improved Particle Swarm Optimisation (IPSO) by \citet{zhao2006}. In IPSO the term representing the social influence (i.e., $\vec{G}^t-\vec{X}_{i}^t$, in equations~\ref{eq:update1} or~\ref{eq:update2}) is enhanced by using information drawn from a subset containing the $n_{gb}$ best performing particles in the neighbourhood. According to \citet{zhao2006} this variant follows the analogy where a group of leaders, i.e. the best performing particles for an iteration, could influence positively better decisions for society (swarm) compared to a case when a single leader is followed. IPSO is implemented as follows 

\begin{equation}\label{eq:IPSO}
\vec{V}_{i}^{t+1} = \omega\vec{V}_{i}^t + c_1 \vec{U}_1^t \otimes (\vec{P}_{i}^t-\vec{X}_{i}^t) + \sum_{j=1}^{n_{gb}} c_{2,j} \vec{U}_{2,j}^t \otimes (\vec{G}_{j}^t-\vec{X}_{i}^t)
\end{equation} 

\noindent where coefficient $c_{2,j}$ is defined by

\begin{equation}
c_{2,j}=c_2 \hat{g}_{j}
\end{equation}

\noindent where $\hat{g}_{j}$ is a weighting factor based on the values of the goodness-of-fit for the $n_{gb}$ particles. 

\subsubsection{Fine-Tuning Options\label{ch:finetuneoptions}}
In this section several options used to tailor the calibration engine to specific user needs are described. We should note here that the effectiveness of these options has generally been tested against the ``canonical'' PSO algorithm.

\begin{enumerate}
\item PSO Parameters \\
The PSO algorithm includes a few parameters that have to be carefully selected in order to avoid swarm explosion and to ensure proper convergence of the algorithm. These parameters include: a) inertia weight $(\omega)$, b) Clerc's constriction factor $(\chi)$, c) the cognitive coefficient $(c_1)$, and d) the social coefficient $(c_2)$.

Several definitions for the \emph{inertia weight} ($\omega$) have been extensively investigated and, hence, will not be further developed here. \citet{shieberhart1998b} initially propose a linearly decreasing variation for $\omega$. This strategy forces an extensive exploration of the search-space at initial iterations, which gradually shifts to a more dissipative (``exploitative'') search at later iterations \citep{poli+al2007}. Alternative $\omega$ definitions implemented in \emph{hydroPSO} include: a) linear \citep{shieberhart1998b}, b) non-linear \citep{chatterjeesiarry2006}, c) adaptive factor \citep{liu+al2005}, d) global-local best ratio \citep{arumugamrao2008}, and e) fully random \citep{eberhartshi2001}. These alternative definitions for $\omega$ allow the modeller to fine-tune the ``exploitation/exploration'' properties of the algorithm for different calibration problems.

Depending on the nature of the optimisation/calibration problem, the definition of the acceleration coefficients $c_1$ and $c_2$ may have a drastic impact on the algorithm's performance. \citet{ratnaweera+al2004} suggest that time-varying acceleration coefficients (TVAC) may reduce premature convergence at the first stages of the search and improve convergence at later iterations. For example, a large value of $c_1$ and a small value of $c_2$ at initial iterations allow the particles to ``fly'' around the search-space instead of moving towards their personal best. For later iterations, in turn, a small value of $c_1$ and a large value of $c_2$ allow the particles to converge to the global attraction zone. Based on this, linear, non-linear, and global-local best ratio (only for $c_1$) TVAC are implemented in \emph{hydroPSO} to fine-tune the coefficients $c_1$ and $c_2$.

\item Boundary Conditions \\
In many optimisation/calibration problems it is a good practice to confine particle position to physically meaningful parameter ranges. In \emph{hydroPSO} this is done by using a $D$-dimensional vector defining the range of the search-space $(\Psi=\{(\psi_{1}^{min},\psi_{1}^{max}),(\psi_{2}^{min},\psi_{2}^{max}),\ldots,(\psi_{D}^{min},\psi_{D}^{max})\})$. The behaviour of the particles at these boundaries may influence the exploration of the search-space \citep{robinsonrahmatsamii2004}. Generally, four types of boundary condition may be imposed on a particle reaching the boundary of the search-space: a) \emph{absorbing}, where the particle's position is set to the boundary value and the velocity is set to zero; b) \emph{invisible}, where the particle is allowed to ``fly'' beyond the boundaries without limiting either its position or velocity, but its goodness-of-fit is not evaluated, c) \emph{reflecting}, where the sign of the velocity in the overshot dimension is changed and the particle is reflected back to the search-space; and d) \emph{damping}, where part (1-$f$) of the velocity is absorbed by the boundary and part ($f$) is reflected back, with $f$ as a random damping factor in [0,1] \citep[see][]{robinsonrahmatsamii2004,huangmohan2005}.

\item Regrouping Strategy \\
In the case of premature convergence (i.e. when the proposed solution approximates a local rather than a global optimum) or to validate the global attraction zone at final iterations, a suitable mechanism allowing particles to escape from sub-optimal solutions is required. \citet{eversghalia2009} propose a strategy that avoids stagnation of particles by automatically triggering swarm regrouping (see Table~\ref{tab:table2} for details). At each iteration the \emph{swarm radius} ($\delta^t$) is computed as the maximum Euclidean distance between the position of the swarm optimum ($\vec{G}$) and any given particle ($\vec{X}_i$). Then, regrouping is triggered when the \emph{normalized swarm radius} ($\delta^t_{norm}$) is less than a user-defined \emph{stagnation threshold} ($\epsilon$). The swarm is regrouped around the swarm optimum by using an updated range ($range_{d}(\Psi^{r})$ where $r$ is the \emph{swarm regrouping index}) calculated as the minimum between (i) the original range of the search-space on dimension $d$, and (ii) the product of the \emph{regrouping factor} ($\rho$) with the maximum distance along dimension $d$ between any particle and the swarm optimum. This regrouping method defines a reduced search-space ($\Psi^{r}$), which is small enough for an efficient search and large enough to allow particles to escape from sub-optimal solutions.  

\item Other Options \\
In \emph{hydroPSO} sampling of initial particle position $(\vec{X}_{ini})$ and velocity $(\vec{V}_{ini})$ might be improved by including a Latin Hypercube sampling \citep{mckay1979} over the full $D$-dimensional search-space in order to ensure a fair initialisation of the $D$ exploration. 

To enhance a faster propagation of the best solutions found throughout the swarm, \citet{mussi+al2009} discuss two strategies for updating the particle and local best position. In the \emph{synchronous} strategy the local best is updated only after computing and updating the position and personal best of all particles in the swarm. In the \emph{asynchronous} strategy, the local best is updated immediately after each particle's position is updated. 

For later stage iterations, oscillation of the particles around the local best may be restricted by using a time-varying $\vec{V}_{max}$. This reduces the search-space for latter stage iterations and, thus, complements the effect of ($\omega$). This is suggested by the authors of \emph{hydroPSO} following \citet{chatterjeesiarry2006}.

Finally, \emph{hydroPSO} offers parallel capabilities to speed up the optimization process, which are easily configured.
\end{enumerate}

\subsection{Standard PSO 2011 (SPSO 2011)\label{ch:}}
In a series of technical reports \citep[see][]{clerc2007,clerc2009,clerc2012}, a clear need to define a ``Standard PSO algorithm'' has been identified. This stems mainly from the need to establish a common benchmark to assess the performance of the numerous PSO improvements proposed in the literature. To date, three versions of the standard PSO algorithm exist: SPSO 2006, SPSO 2007, and SPSO 2011 \citep{clerc2012}. We should point out that SPSO 2011 has in fact been designed as a benchmark for algorithm performance and is not intended to be the best available PSO algorithm in the literature \citep{clerc2012}.

The most recent benchmark proposed, SPSO 2011, starts by defining a centre of gravity ($Gr$) around the current $(\vec{X}_{i}^t)$, previous best $(\vec{p}_{i}^{\,t})$, and local best positions $(\vec{l}_{i}^{\,t})$ as follows,

\begin{subequations}
 \begin{align}
  \vec{p}_{i}^{\,t} &= \vec{X}_{i}^t + c_1 \vec{U}_1^t \otimes (\vec{P}_{i}^t-\vec{X}_{i}^t) \label{eq:pprima} \\ 
  \vec{l}_{i}^{\,t} &= \vec{X}_{i}^t + c_2 \vec{U}_2^t \otimes   (\vec{G}^t-\vec{X}_{i}^t)   \label{eq:lprima} \\
  \vec{Gr}_{i}^{t} &= \frac{(\vec{X}_{i}^t + \vec{p}_{i}^{\,t} + \vec{l}_{i}^{\,t})}{3}      \label{eq:gravity}
 \end{align}
\end{subequations}

\noindent then, a random point is defined in the hypersphere $\mathcal{H}(\vec{Gr}_{i}^{t},||\vec{Gr}_{i}^{t}-\vec{X}_{i}^t||)$, and velocity is updated as follows,

\begin{equation}
 \vec{V}_{i}^{t+1} = \omega \vec{V}_{i}^t + r \mathcal{H}(\vec{Gr}_{i}^{t},||\vec{Gr}_{i}^{t}-\vec{X}_{i}^t||) - \vec{X}_{i}^t
\end{equation}

\noindent where $r$ is a random number in $[0,1]$. The particle's position is updated following equation~\eqref{eq:PositionUpdate}.

Despite the fact that SPSO 2011 is an improvement to the previous SPSO 2007 in terms of accounting for rotational invariance, SPSO 2007 could perform better than SPSO 2011 for separable and (least likely) for non-separable functions (Maurice Clerc, developer SPSO 2007 \& 2011, personal communication, 2012). This is the main reason for including both SPSO 2007 \& SPSO 2011 in the \emph{hydroPSO} R package.

\singlespacing
%%%%%% TABLE2 
\begin{table}[!ht]
	\caption{Main features for customising the \emph{hydroPSO} calibration engine.}
	\label{tab:table2}
	\centering
	\resizebox{\textwidth}{!}{
	\begin{threeparttable}
	\begin{tabular}{llll}
\toprule
Feature & \emph{hydroPSO} argument & Description & References \\
\midrule
1. Definition of         & \Verb+use.IW=TRUE+ & 1.1. Linear variation & \\ 
 inertia weight $\omega$ & \Verb+IW.type="linear"+ & $\omega_{iter}=\left[\frac{iter_{max}-iter}{iter_{max}}\right]  \left(\omega_{ini}-\omega_{fin}\right)+\omega_{fin}$~\tnote[a] &  \citet{shieberhart1998b} \\
 & & 1.2. Non-linear variation & \\
 & \Verb+IW.type="non-linear"+ & $\omega_{iter}=\left[ \frac{iter_{max}-iter}{iter_{max}}\right]^n \left(\omega_{ini}-\omega_{fin}\right)+\omega_{fin}$~\tnote[a] & \citet{chatterjeesiarry2006}\\
 & & 1.3. Adaptive Inertia Weight Factor (AIWF) & \\
 & \Verb+IW.type="aiwf"+ & $\omega_{iter}=\left\{
   \begin{array}{l l}
     \left[ \frac{(\omega_{max}-\omega_{min})(f-f_{min})}{f_{avg}-f_{min}} \right] + \omega_{min} & , f \leq f_{avg} \\
        \omega_{max}                                                                              & , f > f_{avg} \\         
      \end{array} \right.$~\tnote[b] & \citet{liu+al2005} \\
 & & 1.4. Global-Local best ratio inertia weight & \\
 & \Verb+IW.type="GLratio"+ & $\omega_{iter}=1.1+\frac{G_d^t}{\overline{P_{id}^t}}$~\tnote[c] & \citet{arumugamrao2008} \\
 & & 1.5. Random inertia weight & \\
 & \Verb+IW.type="runif"+ & $\omega_{iter}=0.5+\frac{rnd(\omega_{ini},\omega_{fin})}{2}$~\tnote[d] & \citet{eberhartshi2001} \\
 & & & \\
2. Time-varying            & \Verb+use.TVc1=TRUE+ & 2.1. Linear variation & \\
 acceleration coefficients & \Verb+TVc1.type="linear"+ & $c1_{iter}=\left[ \frac{iter}{iter_{max}} (c1_{fin}-c1_{ini}) \right]+c1_{ini}$~\tnote[e] & \citet{ratnaweera+al2004} \\
 & & 2.2. Non-linear variation & \\
 & \Verb+TVc1.type="non-linear"+ & $c1_{iter}=\left[ \frac{iter}{iter_{max}} (c1_{fin}-c1_{ini}) \right]^n+c1_{ini}$~\tnote[e] & \emph{hydroPSO} \\
 & & 2.3. Global-Local best ratio & \\
 & \Verb+TVc1.type="GLratio"+ & $c1_{iter}=1.1+\frac{G_d^t}{\overline{P_{id}^t}}$ & \citet{arumugamrao2008} \\
 & & 2.4. Linear variation & \\
 & \Verb+TVc2.type="linear"+ & $c2_{iter}=\left[ \frac{iter}{iter_{max}} (c2_{fin}-c2_{ini}) \right]+c2_{ini}$~\tnote[e] & \citet{ratnaweera+al2004} \\
 & & 2.5. Non-linear variation & \\
 & \Verb+TVc2.type="non-linear"+ & $c2_{iter}=\left[ \frac{iter}{iter_{max}} (c2_{fin}-c2_{ini}) \right]+c2_{ini}$~\tnote[e] & \citet{ratnaweera+al2004} \\
 & & & \\
3. Boundary conditions            & \Verb+boundary.wall="absorbing"+  & 3.1. Absorbing  & \citet{robinsonrahmatsamii2004} \\
 definition                       & \Verb+boundary.wall="invisible"+  & 3.2. Invisible  & \citet{robinsonrahmatsamii2004} \\
                                  & \Verb+boundary.wall="reflecting"+ & 3.3. Reflecting & \citet{robinsonrahmatsamii2004} \\
                                  & \Verb+boundary.wall="damping"+    & 3.4. Damping    & \citet{huangmohan2005} \\
 & & & \\
4. Regrouping & \Verb+use.RG=TRUE+ & 4.1. $swarm~radius=\delta^t=max \Arrowvert \overrightarrow{X}_{i}^t-\overrightarrow{G}^t\Arrowvert$~\tnote[f]  & \citet{eversghalia2009} \\
              & \Verb+RG.thr=+$\epsilon$ & $normalized~swarm~radius=\delta^t_{norm}=\frac{\delta^t}{diam(\Psi)}<\epsilon$ & \\
              & & $diam(\Psi)=\Arrowvert range_d(\Psi) \Arrowvert$ & \\
              & & $range_d(\Psi)=X_{d}^U-X_{d}^L$ & \\
              & \Verb+RG.r=+$\rho$ & $range_d(\Psi^r)=min \left\lbrace range_d(\Psi^0),\rho~max|X_{id}^{r-1}-G_d^{r-1}|\right\rbrace$ &\\
              & \Verb+RG.miniter=+$r$ & $\overrightarrow{X}_i=G^{r-1}+\left[\overrightarrow{r_3} \cdot range_i(\Psi^r)-\frac{1}{2} range_i(\Psi^r)\right] $ &\\
              & & $V_{d}^{max}=\lambda range_d(\Psi^r)$ & \\
 & & & \\
5. Definition of $X_{ini}$ & \Verb+Xini.type="random"+ & 5.1. Random & \emph{hydroPSO} \\
                           & \Verb+Xini.type="lhs"+    & 5.2. Latin Hypercube Sampling (LHS) & \emph{hydroPSO} \\
 & & & \\
6. Definition of $V_{ini}$ & \Verb+Vini.type="random2007"+ & 6.1. Random following SPSO 2007 & \citet{clerc2012} \\
                           & \Verb+Vini.type="lhs2007"+    & 6.2. LHS following SPSO 2007    & \citet{clerc2012} \\
                           & \Verb+Vini.type="zero"+       & 6.3. Zero velocity              & \emph{hydroPSO} \\
                           & \Verb+Vini.type="random2011"+ & 6.4. Random following SPSO 2011 & \citet{clerc2012}\\
                           & \Verb+Vini.type="lhs2011"+    & 6.5. LHS following SPSO 2011    & \citet{clerc2012}\\
 & & & \\
7. Update of positions & \Verb+best.update="sync"+  & 7.1. Synchronous & \citet{mussi+al2009}\\
 and velocities        & \Verb+best.update="async"+ & 7.2. Asynchronous & \citet{mussi+al2009}\\
 & & & \\
8. Time-varying   & \Verb+use.TVlambda=TRUE+ & $\vec{V}_{max}^{iter}= \lambda^{iter}\vec{X}_{max}$ & \\
 maximum velocity & & 8.1. Linear variation & \\
 & \Verb+TVlambda.type="linear"+ & $\lambda^{iter}=\left[ \frac{iter}{iter_{max}} (\lambda^{fin}-\lambda^{ini}) \right]+\lambda^{ini}$~\tnote[g] & \citet{chatterjeesiarry2006} \\
                                 & & 8.2. Non-linear variation & \\
 & \Verb+TVlambda.type="non-linear"+ & $\lambda^{iter}=\left[ \frac{iter}{iter_{max}} (\lambda^{fin}-\lambda^{ini}) \right]^n+\lambda^{ini}$~\tnote[g] & \emph{hydroPSO} \\
 & & & \\
9. Topologies & \Verb+topology="gbest"+      & 9.1. \emph{gbest}         & \citet{kennedymendes2002} \\
              & \Verb+topology="lbest"+      & 9.2. \emph{lbest}         & \citet{kennedymendes2002} \\
              & \Verb+topology="vonNeumann"+ & 9.3. von Neumann ($k=4$)  & \citet{kennedymendes2002} \\
              & \Verb+topology="random"+     & 9.4. Random ($k=3$)       & \citet{clerc2012} \\
 & & & \\
10. PSO Variants    & \Verb+method="pso"+   & 10.1. Canonical PSO                 & \citet{clerc2007} \\
                    & \Verb+method="fips"+  & 10.2. Fully Informed Particle Swarm & \citet{mendes+al2004} \\
                    & \Verb+method="wfips"+ & 10.3. Weighted FIPS                 & \citet{mendes+al2004} \\
                    & \Verb+method="ipso"+  & 10.4. Improved PSO (IPSO)           & \citet{zhao2006} \\
                    & \Verb+method="spso2007"+ & 10.5. Standard PSO 2007 & \citet{clerc2012} \\
                    & \Verb+method="spso2011"+ & 10.6. Standard PSO 2011 & \citet{clerc2012} \\
 & & & \\
11. Normalisation   & \Verb+method="normalise"+ & 11.1. Standard PSO 2011 & \citet{clerc2012} \\
 & & & \\
12. Parallelisation & & & \\
\bottomrule
	\end{tabular}
			\begin{tablenotes}
			\item[a] $\omega_{iter}$ is the current inertia weight, $\omega_{ini}$ and $\omega_{fin}$ are the initial and final inertia weights, and $n$ is the non-linear modulation index.
			\item[b] $f$ is the current objective value of the particle, $f_{avg}$ is the average objective value for all the particles, $f_{min}$ is the minimum objective value of all the particles, $\omega_{max}$ and $\omega_{min}$ are user-defined maximum and minimum values for $\omega$.
			\item[c] It sets a minimisation problem where $G_d^t$ and $\overline{P_{id}^t}$ are the local best and the average of all personal bests during iteration $t$, respectively.
			\item[d] $rnd()$ is a random number in [$\omega_{ini},\omega_{fin}$].
			\item[e] $c1_{ini}$, $c1_{fin}$, $c2_{ini}$, $c2_{fin}$ are constants.
      \item[f] $\overrightarrow{X}_{i}^{t}$ are particles' positions, $\overrightarrow{G}^{t}$ is local best location, $\epsilon$ is the stagnation threshold, $diam(\Psi)$ is the diameter of the search-space, $range_d(\Psi)$ is the length of the search-space along dimension $d$, $X_{d}^{U}$ and $X_{d}^{L}$ are the upper and lower bounds of the search-space, $\Psi^{r}$ is the regrouped search-space, $r$ is the $swarm~regrouping~index$, $\Psi^{0}$ is the original search-space, $\rho$ is the regrouping factor, $\overrightarrow{r_3}$ is a uniform random vector, and $\lambda$ is a percentage to limit $\vec{V}_{max}$.
			\item[g] $\lambda^{iter}$ is a percentage to limit $\vec{V}_{max}$, and $\lambda^{ini}$ and $\lambda^{fin}$ are the percentage to limit $\vec{V}_{max}$ at the start and end of a given run, respectively.
		\end{tablenotes}	
	\end{threeparttable}
}
\end{table}
%%% END TABLE2 

\clearpage

\section{Description of the hydroPSO Package\label{sec:package}}
\emph{hydroPSO} is a multi-platform and model-independent R package that has been designed to allow the user to perform sensitivity analysis, model calibration, and assessment of the results. Sensitivity analysis is performed by using the LH-OAT method \citep{vangriensven+al2006}. Sensitive parameters are then calibrated by tailoring the calibration engine to specific user needs through the use of the numerous PSO variants and fine-tuning options described in Section~\ref{sec:PSOvariants}. Finally, advanced plotting functionalities together with detailed information regarding the evolution of the algorithm's performance facilitate the interpretation and assessment of the calibration results.

\subsection{Main hydroPSO Functions\label{ch:mainfunctions}}
The interaction among the main functions comprising the \emph{hydroPSO} package is shown in Figure~\ref{fig:f01bvign}. These functions have been specifically developed for \emph{hydroPSO} and are summarised in Table~\ref{tab:table3} and further described below.

\begin{figure}[!h]
	\centering
	\noindent\includegraphics[width=\textwidth]{./figures/f01bvign.pdf} 
	\caption{Flowchart describing the interaction of the main hydroPSO functions. User-defined files \texttt{ParamRanges.txt} and \texttt{ParamFiles.txt} provide information on the parameters to be calibrated, whereas \texttt{out.FUN()}, \texttt{gof.FUN()}, and observations are used to assess the quality of the particles' positions through a goodness-of-fit measure. Light-blue shaded boxes require user intervention \citep[After][]{hydroPSO2012}.}
	\label{fig:f01bvign}
\end{figure}

%%%%%%% TABLE3
\begin{table}[!h]
 \caption{Main functions included in the \emph{hydroPSO} R package.}
 \label{tab:table3}
 \centering
 \resizebox{\textwidth}{!}{
\begin{tabular}{l p{14cm}}
\toprule
Function                 & Short Description  \\
\midrule
\Verb+lhoat()+           & Sensitivity analysis using LH-OAT \citep{vangriensven+al2006} \\
\Verb+hydromod()+        & Control of the model code to be calibrated \\
\Verb+hydroPSO()+        & Multi-platform and model-independent enhanced PSO calibration engine \\
\Verb+read\_results()+   & Reading of results produced by \emph{hydroPSO}. It is a wrapper to: \\
\hspace{0.5cm}\indent \Verb+read\_particles()+      & Reading \emph{``Particles.txt''} output file \\
\hspace{0.5cm}\indent \Verb+read\_velocities()+     & Reading \emph{``Velocities.txt''} output file \\
\hspace{0.5cm}\indent \Verb+read\_out()+            & Reading \emph{``of\_out.txt''} output file \\
\hspace{0.5cm}\indent \Verb+read\_convergence()+    & Reading \emph{``ConvergenceMeasures.txt''} output file \\ 
\hspace{0.5cm}\indent \Verb+read\_GofPerParticle()+ & Reading \emph{``Particles\_GofPerIter.txt''} output file \\
\Verb+plot\_results()+                              & Plotting of results produced by \emph{hydroPSO}. It is a wrapper to: \\
\hspace{0.5cm}\indent \Verb+plot\_particles()+      & Plotting parameters \\
\hspace{0.5cm}\indent \Verb+plot\_velocities()+     & Plotting the evolution of particles' velocities \\
\hspace{0.5cm}\indent \Verb+plot\_out()+            & Plotting model outputs (simulated equivalents) \\
\hspace{0.5cm}\indent \Verb+plot\_convergence()+    & Plotting the evolution of the global optimum and $\delta^t_{norm}$\\
\hspace{0.5cm}\indent \Verb+plot\_GofPerParticle()+ & Plotting the evolution of the goodness-of-fit per particle \\
\Verb+verification()+    & Run the model code with one or more parameter sets specified by the user \\
\Verb+PEST2hydroPSO+     & Convert PEST files into input files for a \emph{hydroPSO} optimisation \\
\Verb+hydroPSO2PEST+     & Convert \emph{hydroPSO} files into input files for a PEST optimisation \\
\Verb+test\_functions()+ & Implementation of a set of $n$-dimensional test functions for benchmarking \\
\bottomrule
\end{tabular}
}
\end{table}
%%% END TABLE3 

\begin{enumerate}
\item The \Verb+lhoat()+ function implements the Latin Hypercube One-factor-At-a-Time (LH-OAT) sensitivity analysis technique \citep{vangriensven+al2006}. \Verb+lhoat()+ produces a ranking with the parameter having the largest effect receiving a rank of 1 and the one(s) with the smallest effect receiving a rank equal to the total number of parameters ($D$). LH-OAT works by taking $M$ LH sampling points ($M$ strata for each parameter) and then varying, by a fraction $s$, each LH sampling point $D$ times, where $D$ is the number of parameters. For each LH sampling point a partial impact for each parameter is calculated and then a final impact (on model performance/predictions) is obtained by averaging these partial impacts. The method is very efficient requiring a total of only $M(D+1)$ runs.

\item The \Verb+hydromod()+ function is one of the key components of \emph{hydroPSO}. It has a unique role consisting of linking and controlling the execution of a user-defined model code with \emph{hydroPSO}. \Verb+hydromod()+ first reads a set of parameter values, which are then written into the corresponding model input file(s) by using the information provided in the user-defined \emph{ParamFiles.txt} file. \emph{ParamFiles.txt} defines the name of the model parameters, input files, and specific location of the parameters in the input files. Unlike tools such as PEST \citep{pest2010}, UCODE-2005 \citep{poeter2005}, OSTRICH \citep{ostrich2005} or MADS \citep{mads2012}, this is done in one file only with no need for creating numerous \emph{template} files replicating model input files. Then, \Verb+hydromod()+ executes the model code to obtain the corresponding model outputs, which are read through the \Verb+out.FUN()+ R function. Finally, simulated equivalents are assessed against user-provided observations of system state variables through a \Verb+gof.FUN()+ R function. \Verb+hydromod()+ returns the simulated equivalents and the corresponding goodness-of-fit values.

\item The main calibration engine is implemented in the \Verb+hydroPSO()+ function. This function is another key component of \emph{hydroPSO} that includes state-of-the-art PSO variants and numerous fine-tuning options to customize the calibration engine to specific user needs (see Table~\ref{tab:table2}). At the first iteration, parameters are sampled from a feasible range obtained from the user-defined \emph{ParamRanges.txt} file. Then, \Verb+hydromod()+ is called to obtain a goodness-of-fit measure for each particle in the swarm. Particle velocity and position evolve according to the user-defined PSO configuration until some termination criteria are met (e.g. maximum number of iterations (\Verb+maxiter+), or relative changes in the personal best (\Verb+reltol+) or global best (\Verb+abstol+) are less than a user-defined threshold). \Verb+hydroPSO()+ returns the optimum parameter set, all sampled parameters and their corresponding goodness-of-fit, model outputs, particle velocity, and convergence measures.

\item Results from the \Verb+hydroPSO()+ function are post-processed using the \Verb+plot_results()+ function, which delivers a series of user-friendly and customized plots to facilitate the assessment of the model calibration. These plots include: parameter scatter plots, histograms and empirical CDFs, (pseudo) 3D scatter plots, parameters and velocities for each iteration, goodness-of-fit value for each particle per iteration, and the evolution of the convergence measures.

\item The \Verb+verification()+ function is designed to validate (one or more) user-defined parameter sets. It returns a goodness-of-fit measure for each parameter set defined, the best parameter set, and the goodness-of-fit measure corresponding to the best parameter set.

\item Function \Verb+PEST2hydroPSO+ translates the files generated to run a PEST model calibration (i.e. *.tpl, *.pst, and *.ins) into the basic files to set up a \emph{hydroPSO} optimization (i.e. \Verb+ParamFiles.txt+, \Verb+ParamRanges.txt+ and \Verb+hydroPSO-script.R+). 

\item Function \Verb+hydroPSO2PEST+ translates the \emph{hydroPSO} files into the basic files for performing a PEST local-calibration. This function is particularly useful for obtaining detailed information on sensitivity and uncertainty of parameters once a global optimisation has been performed using \emph{hydroPSO}. In particular, this function would allow linking \emph{hydroPSO} with tools using PEST-based templates, such as, OSTRICH, UCODE-2005, and squads/MADS.

\item The \emph{hydroPSO} package includes a series of n-dimensional functions commonly used as benchmarks to assess the performance of optimisation algorithms. These functions are described in the \Verb+test_functions()+ function.
\end{enumerate}

\subsection{\texttt{ParamFiles.txt} and \texttt{ParamRanges.txt}}
The interface of \emph{hydroPSO} with a model code uses two simple ASCII files, namely, \Verb+ParamFiles.txt+ and \Verb+ParamRanges.txt+, which should suffice for basic applications. For more advanced applications and in addition to the definition of the previous ASCII files, \emph{hydroPSO} may require the definition of basic R wrapper functions reading model inputs and outputs, and computing the model's performance if required. In sections~\ref{sec:interfacingswat2005} and~\ref{sec:wrappers} we provide examples of both cases.

\Verb+ParamFiles.txt+ file defines the exact location of the parameters to be calibrated in the model input files. The format of \Verb+ParamFiles.txt+ is as follows,

\begin{Verbatim}[frame=single,label=ParamFiles.txt,fontsize=\scriptsize]
ParameterNmbr ParameterName Filename Row.Number Col.Start Col.End DecimalPlaces
1             par1          file1    x1         y1        z1      w1
2             par2          file1    x2         y2        z2      w2
3             par3          file2    x3         y3        z3      w3
4             par4          file3    x4         y4        z4      w4
1             par1          file4    x5         y5        z5      w5
1             par1          file5    x5         y5        z5      w5
.             .             .        .          .         .       .
.             .             .        .          .         .       . 
.             .             .        .          .         .       .
n             parn          filem    xn         yn        zn      wn
\end{Verbatim}

\noindent where \Verb+ParameterNmbr+ is a consecutive number assigned to each parameter, \Verb+ParameterName+ is a user-defined parameter name, \Verb+Filename+ is the name of the model input file where the corresponding \Verb+ParameterName+ is located, \Verb+Row.Number+ is the row number in the \Verb+Filename+ file where \Verb+ParameterName+ can be found, \Verb+Col.Start+ and \Verb+Col.End+ define the column numbers in the \Verb+Filename+ file where \Verb+ParameterName+ can be found, and \Verb+DecimalPlaces+ defines the decimal places for the corresponding \Verb+ParameterName+ value. Please note that the same file (\Verb+file1+) can include more than one parameter (\Verb+par1+ and \Verb+par2+) located in different places in the file, and also that the same parameter (\Verb+par1+) can appear in different input files (\Verb+file1+, \Verb+file4+, \Verb+file5+). In addition, it is very important to define \Verb+Col.Start+ and \Verb+Col.End+ in such a way that the parameter value AND its decimal places fit the width defined as \Verb+Col.Start+ - \Verb+Col.End+ + 1. For users familiar with PEST \citep{pest2010} \Verb+Col.Start+ and \Verb+Col.End+ are equivalent to the token used to define \emph{where} to write parameters during the optimisation.

\Verb+ParamRanges.txt+ file defines the feasible range for each of the parameters to be calibrated. The format of \Verb+ParamRanges.txt+ is as follows,

\begin{Verbatim}[frame=single,label=ParamRanges-Sens.txt,fontsize=\scriptsize]
ParameterNmbr ParameterName MinValue MaxValue     
1             par1          min1     max1
2             par2          min2     max2
3             par3          min3     max3
4             par4          min4     max4
5             par5          min5     max5
.             .             .        .
.             .             .        .
.             .             .        .
n             parn          minn     maxn
\end{Verbatim}

\noindent where \Verb+MinValue+ and \Verb+MaxValue+ are the minimum and maximum parameter values, respectively. Note that care must be taken in numbering and naming the parameters to be calibrated as they require to be consistent in both files.

\clearpage

\section{Step-by-Step \emph{hydroPSO} Application\label{sec:application}}
\subsection{Setting Up the Environment\label{sec:setenv}}

\begin{enumerate} 

\item Use next commands to retrieve current working directory, set a new working directory, and printing files included in the current directory, respectively.
<<eval=FALSE>>=
getwd()
setwd("~/tmp")
list.files(".")
@

\item Installing \emph{hydroPSO}.
<<eval=FALSE>>=
install.packages("hydroPSO")
@

\item Loading the \emph{hydroPSO} library containing data and functions used in this analysis.
<<>>=
library(hydroPSO)
@

\end{enumerate}

\subsection{Basic \emph{hydroPSO} Application\label{sec:basicapp}}
This section illustrates the implementation of the \emph{hydroPSO} package to optimise two (highly) multi-modal and multi-dimensional test functions with a considerable number of local sub-optimal solutions. These functions are commonly used as benchmarking for the performance of optimisation algorithms. Otherwise stated, the optimal solution for these functions should be zero.

In this section we do not aim at finding an ``optimum'' configuration for the \emph{hydroPSO} parameters, which in itself can be a massive task. Instead, we illustrate a few controlling options to handle problems such as premature convergence for (highly) multi-modal objective functions. We refer the reader to \citet{hydroPSO2012} for the results of a validation of \emph{hydroPSO} against the Standard PSO 2007 \citep{clerc2012}.


\subsubsection{Optimisation of Ackley Function}
\begin{enumerate}
\item The \textbf{Ackley} test function is multi-modal and separable, with several local optima that, for the search range [-32, 32], look more like noise, although they are located at regular intervals. The Ackley function only has one global optimum located at the point \texttt{o=(0,...,0)}. Complexity of the Ackley function is moderated and algorithms based on gradient steepest descent will be most likely trapped in a local optima. It is defined by:

\begin{equation}\label{eq:ackley}
\begin{split}
f(x)&=20+\exp(1)-20\exp\left(-0.2\sqrt{\frac{1}{n}\sum_{i=1}^{n}x_{i}^2}\right)-\exp\left(\frac{1}{2}\sum_{i=1}^{n}\cos(2\pi x_{i})\right) ; \\
            &-32.7 \leq x_i \leq 32.7 \ ; \ i=1,2,\ldots,n.
\end{split}
\end{equation}

For optimising the Ackley function we need to define the upper and lower limits of the search space [-32;32] and its dimensionality (D=10). Default values are used for the PSO engine (SPSO2011 method, 40 particles, 1000 maxit):
<<eval=TRUE>>=
D <- 10
lower <- rep(-32,D)
upper <- rep(32,D)
set.seed(1111)
hydroPSO(fn=ackley,lower=lower,upper=upper)
@

Solution for the optimisation is reached at iteration 230 (9200 function calls), with an optimum value of \Verb+4.863E-06+

In the previous example, the algorithm finished before reaching the maximum number of iterations (by efault \Verb+maxit=1000+) because the relative tolerance was reached. \Verb+reltol+ is defined as \Verb+sqrt(.Machine$double.eps)+, typically about \Verb+1E-8+.


\item Using less particles (i.e. less number of model runs) to get a global optimum similar to the previous one, using a lower relative tolerance (\Verb+reltol=1E-9+)
<<eval=TRUE>>=
set.seed(1111)
hydroPSO(fn=ackley,lower=lower,upper=upper,
         control=list(npart=20, reltol=1E-9)
        )
@

\item Plotting the results: 
<<eval=TRUE>>=
plot_results(do.png=TRUE, MinMax="min", do.pairs=TRUE)
@

\end{enumerate}

By default \Verb+plot_results+ plots directly to the R graphical device. Using the option \Verb+do.png=TRUE+ all the the graphical outputs are re-directed to \Verb+png+ files stored in \Verb+./PSO.out/pngs/+. Setting \Verb+do.pairs=TRUE+ allows the creation of a matrix plot summarizing the interaction among parameters (cross-correlation, histograms, and statistical significance of the correlation). Results produced are shown in Figures~\ref{fig:convmeas}-\ref{fig:velsperrun}. 

Figure~\ref{fig:convmeas}, shows the evolution of the global optimum and the Normalized Swarm Radius (NSR). The latter indicates the convergence of the swarm to the (optimum) attraction zone. Assessment of both Global Optimum and NSR is particularly useful when the regrouping strategy used to tackle premature convergence is activated (\Verb+use.RG=TRUE+).

Figure~\ref{fig:dottyplots} shows dotty-plots for each of the 10 parameters, where each dot represents an evaluation of the function (model) being optimised. By default, dotty-plots are shown for all parameter sets, however, and as seen from Figure~\ref{fig:dottyplots}, not all of them may show a good performance. At the same time, Figure~\ref{fig:boxplots} shows boxplots summarizing each parameter. Using the options \Verb+beh.thr+ and \Verb+MinMax+, a ``behavioural'' threshold is defined to select a sub-set of the best performing parameters. By defining \Verb+beh.thr+ we discard parameters showing a poor performance and, as such, this shows some parallelism with the specification of the rejection threshold in Generalized Likelihood Uncertainty Estimation (GLUE) \citep[see][]{beven2006a} or the definition of the burn-in samples in Markov Chain Monte Carlo (MCMC) simulation \citep[see][]{gelman2004}. 

Interaction between parameters is shown in Figure~\ref{fig:3Ddottyplots}. This figure shows the interaction between the first 5 parameters (selected by default by \emph{hydroPSO}) as a function of the goodness-of-fit. Using \Verb+dp3D.names+ the user can select specific parameters to plot. If the option \Verb+beh.thr+ is specified, this figure shows the sub-set representing only the best-performance particles.

Figure~\ref{fig:ParamPairs} shows a (matrix) summary of the interaction among parameters. Here, the statistical significance of the correlation as well as dispersion-like and histogram plot summaries are obtained.

Empirical Cumulative Distribution Functions (ECDFs) for each parameter are shown in Figure~\ref{fig:ecdfs}. ECDFs are created for all parameter sets evaluated unless the \Verb+beh.thr+ option is specified. In the last case, ECDFs are built from the sub-set representing the best performance.

Figure~\ref{fig:hist} shows the histograms of parameters. As in Figures~\ref{fig:3Ddottyplots} and~\ref{fig:ecdfs}, these histograms are calculated for all parameter sets retained unless the \Verb+beh.thr+ option is specified. 

Finally, Figures~\ref{fig:gofperiter},~\ref{fig:paramsperrun} and~\ref{fig:velsperrun} provide detailed information about the evolution of the goodness-of-fit function per iteration for each particle defined in the swarm, and particles' positions and velocities versus function (model) evaluation, respectively.

\begin{figure}[h!]
	\centering
	\noindent\includegraphics[width=\textwidth]{./PSO.out/pngs/ConvergenceMeasures.png} 
	\caption{Global Optimum (GOptim) and the Normalized Swarm Radius (NSR) versus iteration number.}
	\label{fig:convmeas}
\end{figure}

\begin{figure}[h!]
	\centering
	\noindent\includegraphics[width=\textwidth]{./PSO.out/pngs/Params_DottyPlots.png} 
	\caption{Dotty-plots for each parameter.}
	\label{fig:dottyplots}
\end{figure}

\clearpage

\begin{figure}[h!]
	\centering
	\noindent\includegraphics[width=\textwidth]{./PSO.out/pngs/Params_Boxplots.png} 
	\caption{Box-plots for each parameter.}
	\label{fig:boxplots}
\end{figure}

\begin{figure}[h!]
	\centering
	\noindent\includegraphics[width=\textwidth]{./PSO.out/pngs/Params_dp3d.png} 
	\caption{2-dimensional projected dotty-plots highlighting the interaction between parameters.}
	\label{fig:3Ddottyplots}
\end{figure}

\clearpage

\begin{figure}[h!]
	\centering
	\noindent\includegraphics[width=\textwidth]{./PSO.out/pngs/Params_Pairs.png} 
	\caption{Matrix summarizing the interaction among parameters (e.g. cross correlation, histograms, and statistical significance of the correlation).}
	\label{fig:ParamPairs}
\end{figure}

\begin{figure}[h!]
	\centering
	\noindent\includegraphics[width=\textwidth]{./PSO.out/pngs/Params_ECDFs.png} 
	\caption{Empirical Cumulative Distribution Functions (ECDFs) for parameters.}
	\label{fig:ecdfs}
\end{figure}

\clearpage

\begin{figure}[h!]
	\centering
	\noindent\includegraphics[width=\textwidth]{./PSO.out/pngs/Params_Histograms.png} 
	\caption{Histograms for parameters.}
	\label{fig:hist}
\end{figure}

\begin{figure}[h!]
	\centering
	\noindent\includegraphics[width=\textwidth]{./PSO.out/pngs/Particles_GofPerIter.png} 
	\caption{Goodness-of-fit measure for particles per iteration.}
	\label{fig:gofperiter}
\end{figure}

\clearpage

\begin{figure}[h!]
	\centering
	\noindent\includegraphics[width=\textwidth]{./PSO.out/pngs/Params_ValuesPerRun.png} 
	\caption{Parameter value per run.}
	\label{fig:paramsperrun}
\end{figure}

\begin{figure}[h!]
	\centering
	\noindent\includegraphics[width=\textwidth]{./PSO.out/pngs/Velocities_ValuePerRun.png} 
	\caption{Particle velocities per run.}
	\label{fig:velsperrun}
\end{figure}


\subsubsection{Optimisation of Rastrigin Function}
\begin{enumerate}
\item The generalized \textbf{Rastrigin} test function (Equation~\ref{eq:rastrigin}) is non-convex, multimodal and additively separable. It has several local optima arranged in a regular lattice, but it only has one global optimum located at the point \texttt{o=(0,...,0)}. The search range for the Rastrigin function is [-5.12, 5.12] in each variable. This function is a fairly difficult problem due to its large search space and its large number of local minima. Algorithms based on gradient steepest descent will be most likely trapped in a local optima.

\begin{equation}\label{eq:rastrigin}
\begin{split}
f(x)&= 10n+\sum_{i=1}^{n}\left[x_{i}^{2}-10\cos(2\pi x_{i})\right] \ ; \ -5.12 \leq x_i \leq 5.12 \ ; \ i=1,2,\ldots,n
\end{split}
\end{equation}

For optimising the Rastrigin function we need to define the upper and lower limits of the search space [-5.12;5.12] and its dimensionality (D=5). Default values are used for the PSO engine (\texttt{method="spso2011"}, \texttt{npart=40}, \texttt{maxit=1000}), while \texttt{write2disk=FALSE} in order to speed up the optimisation by avoiding writing the results to disk:
<<>>=
D <- 5
lower <- rep(-5.12,D)
upper <- rep(5.12,D)
set.seed(100)
hydroPSO(fn=rastrigin, lower=lower, upper=upper,
         control=list(write2disk=FALSE) )
@

In the previous example, the algorithm finished before reaching the maximum number of iterations (\Verb+maxit=1000+) because the relative tolerance was reached. Therefore, we decrease the relative tolerance in order to allow all the iterations be executed \Verb+reltol=1E-20+

\item Using the \Verb+vonNeumann+ topology:
<<>>=
set.seed(100)
hydroPSO(fn=rastrigin,lower=lower,upper=upper,
         control=list(topology="vonNeumann", reltol=1E-20, 
                      REPORT=50, write2disk=FALSE) ) 
@

This time the maximum number of iterations was reached (see the \Verb+message+ output), with a better global optimum than in the previous case, equal to  \Verb+1.9899+.


\item From the R console output we see premature convergence around iteration 300 for a NSR ca.  \texttt{7E-02}, where the global optimum got stagnated in  \texttt{1.990E+00}. One option implemented in \emph{hydroPSO} to tackle this problem corresponds to the ``regrouping strategy'' developed by \citet{eversghalia2009}. For this case we active the regrouping strategy (\Verb+use.RG+) when the NSR is smaller than a threshold \Verb+RG.thr+ equal to \texttt{7E-02}, and the output directory is set to a user-defined value (\texttt{drty.out="PSO.out.rastr"}):
<<eval=TRUE>>=
set.seed(100)
hydroPSO(fn=rastrigin,lower=lower,upper=upper,
     control=list(topology="vonNeumann", reltol=1E-20, REPORT=50, 
                  drty.out="PSO.out.rastr",
                  use.RG=TRUE,RG.thr=7e-2,RG.r=3,RG.miniter=50) )
@

From the previous results we see that the regrouping strategy allows particles escaping from stagnation and finding a new optimum (\texttt{9.9E-01}), which is better than the optimization without regrouping (\texttt{1.99E+00}) for the same number of iterations (\Verb+maxit=1000+).

\item By setting the working directory to \Verb+PSO.out+ and using the \Verb+read_convergence+ \emph{hydroPSO} function we can directly assess the results from the optimization as function of the iterations: 

<<eval=TRUE>>=
setwd("./PSO.out.rastr")
conv <- read_convergence(do.png=TRUE,png.fname="ConvergenceMeasuresRG.png")
@


Figure~\ref{fig:convmeasreag} shows the effect of the regrouping strategy. In this figure we observe the first stagnation occurring at iteration 111, and the corresponding triggering of the regrouping for NSR values smaller than \texttt{7E-02}. After the first triggering, a new exploration stage is activated until a second stagnation is observed  (at iteration 355), triggering a second re-grouping of the swarm. The aforementioned process is repeted a third time at iteration 786 before reaching the maximum number of iterations.

\begin{figure}[h!]
	\centering
	\noindent\includegraphics[width=\textwidth]{./PSO.out.rastr/ConvergenceMeasuresRG.png} 
	\caption{Effect of regrouping strategy on the Global Optimum (Global Optimum) and the Normalized Swarm Radius (NSR) versus iteration number.}
	\label{fig:convmeasreag}
\end{figure}


\item Using the \Verb+fips+ PSO variant with a \Verb+gbest+ topology:
<<>>=
set.seed(100)
hydroPSO(fn=rastrigin,lower=lower,upper=upper, method="fips",
         control=list(topology="gbest",reltol=1E-9,write2disk=FALSE) )
@

With the \Verb+fips+ variant the maximum relative tolerance was reached again, but with a global optimum much better than in the previous cases, equal to  \Verb+1.745E-09+.


\item Finally, using the same \Verb+fips+ PSO variant as before, but with lower relative and absolute tolerance values,\texttt{1E-20} and \texttt{0}, respectively:
<<>>=
set.seed(100)
hydroPSO(fn=rastrigin,lower=lower,upper=upper, method="fips",
                 control=list(topology="gbest", reltol=1E-20, abstol=0, 
                 REPORT=10, write2disk=FALSE) )
@

This time we got the true global optimum for the Rastrigin function was found, equal to  \Verb+0+.

\end{enumerate}



% \subsubsection{Optimisation of Griewank Function}
% Another commonly used benchmark is the Griewank function (Equation~\ref{eq:griewank}). This is similar to the Rastrigin function and shows a series of regularly distributed local optima, which makes the optimisation extremely challenging.

% \begin{equation}\label{eq:griewank}
% f(x)=\frac{1}{4000}\sum_{i=1}^{n}x_{i}^{2}-\prod_{i=1}^{n}\cos\left(\frac{x_i}{\sqrt{i}}\right)+1 \ ; \ -600 \leq x_i \leq 600 \ ; \ i=1,2,\ldots,n.
% \end{equation}

% \begin{enumerate}
% \item For the Griewank function we define upper and lower limits in [-600;600] and dimensionality d=10. For the optimisation we use 20 particles, 4000 iterations and the \Verb+gbest+ topology:
% <<>>=
% lower <- rep(-600,10)
% upper <- rep(600,10)
% set.seed(1111)
% hydroPSO(fn="griewank",lower=lower,upper=upper,
%          control=list(npart=20,maxit=4000,topology="gbest")
%         )
% @

% For this example, the \Verb+reltol+ criterion for convergence, which depends on the numerical characteristics of the machine where R is running, is met. \Verb+reltol+ is defined as \Verb+sqrt(.Machine$$double.eps)+, i.e. the smallest positive floating-point number. Solution for the optimisation is reached at iteration 2202.

% \item Using the \Verb+vonNeumann+ topology:
% <<>>=
% set.seed(1111)
% hydroPSO(fn="griewank",lower=lower,upper=upper,
%          control=list(npart=20,topology="vonNeumann")
%         )
% @

% Again for this case, the \Verb+reltol+ criterion for convergence is achieved at iteration 2287.

% \item Defining a time-variant inertia weight between [1.2;0.4] and a non-linear (exp=1.5) time-variant $c_1$ coefficient between [1.28;1.05]:
% <<>>=
% set.seed(1111)
% hydroPSO(fn="griewank",lower=lower,upper=upper,
%          control=list(npart=20,topology="vonNeumann",
%          use.IW=TRUE,IW.type="linear",
%          IW.w=c(1.2,0.4),use.TVc1=TRUE,TVc1.type=
%          "non-linear",TVc1.rng=c(1.28,1.05),
%          TVc1.exp=1.5))
% @

% Again for this case, the \Verb+reltol+ criterion for convergence is achieved at iteration 2268.

% \item We use here the \Verb+fips+ PSO variant with a \Verb+gbest+ topology and a velocity limiting factor (\Verb+lambda+) of 0.5:
% <<>>=
% set.seed(1111)
% hydroPSO(fn="griewank",lower=lower,upper=upper,
%          method="fips",control=list(npart=20,
%          topology="gbest",use.IW=TRUE,IW.type="linear",
%          IW.w=c(1.2,0.4),use.TVc1=TRUE,TVc1.type=
%          "non-linear",TVc1.rng=c(1.28,1.05),
%          TVc1.exp=1.5,lambda=0.5))
% @

% \item From the R console output we see premature convergence around iteration 1800 for a NSR ca. 10$^{-9}$. One option implemented in \emph{hydroPSO} to tackle this problem corresponds to the ``regrouping strategy'' developed by \citet{eversghalia2009}. For this case we active the regrouping strategy (\Verb+use.RG+) when the NSR is smaller than a threshold (\Verb+RG.thr+) defined as 10$^{-8}$:
% <<>>=
% set.seed(1111)
% hydroPSO(fn="griewank",lower=lower,upper=upper,
%          method="fips",control=list(npart=20,
%          topology="gbest",use.IW=TRUE,IW.type="linear",
%          IW.w=c(1.2,0.4),use.TVc1=TRUE,TVc1.type=
%          "non-linear",TVc1.rng=c(2.2,1.8),TVc1.exp=1.5,
%          use.RG=TRUE,RG.thr=1e-8,lambda=0.5))
% @

% >From the results we see that the regrouping strategy allows particles escaping from stagnation and finding a new optimum (9.9$\times$10$^{-3}$), which is better than the optimization without regrouping (2.7$\times$10$^{-2}$) for the same number of iterations (\Verb+maxit=4000+).

% \item By setting the working directory to \Verb+PSO.out+ and using the \Verb+read_convergence+ \emph{hydroPSO} function we can directly assess the results from the optimization as function of the iterations: 

% <<eval=TRUE>>=
% setwd("PSO.out")
% read_convergence(beh.thr=0.05,MinMax="min",do.png=TRUE,
%           png.fname="ConvergenceMeasuresRegrouping.png")
% @

% Figure~\ref{fig:convmeasreag} shows the effect of the regrouping strategy for iterations with an optimised value smaller than 0.01. In this figure we observe the first stagnation occurring around iteration 1900, and the corresponding triggering of the regrouping for NSR values smaller than 10$^{-8}$. After the first triggering an initial exploration stage is activated until a better optimum is found (ca. 3450 it.), where again a second stagnation is observed. This whole process is repeated 5 times before reaching the maximum number of iterations. 

% \end{enumerate}

% \begin{figure}[h!]
% 	\centering
% 	\noindent\includegraphics[width=\textwidth]{./PSO.out/ConvergenceMeasuresRegrouping.png} 
% 	\caption{Effect of regrouping strategy on the Global Optimum (Global Optimum) and the Normalized Swarm Radius (NSR) versus iteration number.}
% 	\label{fig:convmeasreag}
% \end{figure}


\emph{hydroPSO} has been validated against the Standard PSO 2007 algorithm developed by \citet{clerc2012} employing five test functions commonly used to assess the performance of optimisation algorithms. Validation indicates that both the Standard PSO 2007 and \emph{hydroPSO} produce comparable average results for fixed boundary condition, topology, inertia weight and number of iterations. For a detailed validation analysis we refer the reader to \citet{hydroPSO2012}.

Finally, here we have illustrated a few options to boost the performance of the \emph{hydroPSO} package or to adapt the optimisation engine to different problems (e.g. premature convergence). We must note, however, that a successful optimisation for a given model code is most likely a proper combination of modeller's expertise and a versatile optimisation engine.

\clearpage

\section{Calibration of a Semi-Distributed Hydrological Model Using \emph{hydroPSO}\label{sec:swat2005}}
\subsection{Hydrological System and Conceptualization\label{sec:swmodel}}
The Ega River is a tributary of the Ebro River and originates in \'Alava (Cantabrian mountain range) flowing through the province of Navarra (see Figure~\ref{fig:fega01}). It has an area of 1445~km$^2$ and elevations ranging from 300 to 1400 m above sea level (a.s.l.) \citep{CHE2000}. For the implementation of the \emph{hydroPSO} package we concentrate on the headwater of the Ega catchment. This upper catchment has an area of 808 km$^2$, mean annual precipitation of ca.~818~mm~year$^{-1}$ and mean daily discharge equal to 12.5~m$^3$~s$^{-1}$ measured in Ega en Estella (Q071 in Figure~\ref{fig:fega01}) for the period 1961-1990.

Simulated daily discharges were obtained with the Soil and Water Assessment Tool (SWAT) 2005 \citep{arnold+al1998,arnoldfohrer2005}, which is a basin scale, physically-based, continuous-time hydrological model operating on a daily time step. Model components include weather, hydrology, erosion/sedimentation, and diverse components for the plant-soil-nutrients system. For a full overview the reader is referred to \citet{arnold+al1998} and \citet{neitsch+al2005a}.

\begin{figure}[h!]
	\centering
	\noindent\includegraphics[width=0.8\textwidth]{./figures/fega01.jpg} 
	\caption{Location of the Ega River catchment and gauging station (Q071) used for calibration.}
	\label{fig:fega01}
\end{figure}

We set up SWAT-2005 with the modified SCS curve number for computing surface runoff, the Priestley-Taylor method for computing the evapotranspiration (ETP), and the Muskingum procedure for the channel routing \citep[see][]{neitsch+al2005a}. The AVSWAT-X GIS interface \citep[see][]{diluzio+al2004} was used to prepare all the input files required by SWAT-2005. Information on weather, topography, soil properties, and land use in the study area was provided by the Confederaci\'{o}n Hidrogr\'{a}fica del Ebro (CHE). Dominant soils in the catchment are marlstones, argillaceous marlstones, and breccia, whereas dominant land uses are forest (57.5\%), pasture (39.0\%), agriculture (2.95\%), rocks (0.4\%) and urban areas (0.12\%). Precipitation estimates were obtained from interpolation of daily data in four rain gauges (P9175, P9176, P9095, P9177U see Figure~\ref{fig:fega01}).

SWAT-2005 contains numerous parameters describing processes where hydrology, water quality, and the soil-plant system interact. Table~\ref{tab:swatparams} shows a subset of 22 parameters (potentially) relevant for hydrological simulations \underline{only}. These parameters are located in different files required for SWAT-2005 (see column Location in Table~\ref{tab:swatparams}) and, thus, this tutorial illustrates how to interface \emph{hydroPSO} and a model code with multiple controlling files (see Section~\ref{sec:interfacingswat2005}). As explained later, only sensitive parameters were selected for calibrating the hydrological model for the Ega headwater catchment.

\begin{table}
\caption{Parameters of the SWAT-2005 model relevant for hydrological simulation. Range and sensitivity ranking constitute the basis for the implementation of the \emph{hydroPSO} package to calibrate SWAT-2005 in the upper Ega catchment.}
\label{tab:swatparams}
\centering
\resizebox{\textwidth}{!}{
\begin{threeparttable} 
\begin{tabular}{l l c c c c c}
\toprule
\multirow{2}{*}{Parameter} & & SWAT-2005 & \multicolumn{2}{c}{Range} & Default & Sensitivity \\ 
\cmidrule{4-5}
                           & & File      &    Min     &     Max      &  Value  & Ranking\tnote{1} \\
\midrule
Baseflow alpha factor [days]               & ALPHA\_BF  & *.gw   & 1.00e-01 & 9.90e-01   & 4.80e-02  & 1 \\
Manning's ``n'' value for the main channel [-] & CH\_N2 & *.rte  & 1.60e-02 & 1.50e-01   & 1.40e-02  & 2 \\
Initial SCS CN II value [-]                & CN2        & *.mgt  & 4.00e+01 & 9.50e+01   & 5.21e+02\tnote{2} & 3 \\
Saturated hydraulic conductivity [mm/hr]   & SOL\_K     & *.sol  & 1.00e-03 & 1.00e+03   & 4.28e+00\tnote{2} & 4 \\
Available water capacity [mm H2O/mm soil]  & SOL\_AWC   & *.sol  & 1.00e-02 & 3.50e-01   & 1.20e-01\tnote{2} & 5 \\
Effective hydraulic conductivity in main channel alluvium [mm/hr]& CH\_K2   & *.rte & 0.00e+00 & 2.00e+02 & 0.00e+00 & 6 \\
Soil evaporation compensation factor [-]   & ESCO       & *.hru  & 1.00e-02 & 1.00e+00   & 9.50e-01  & 7 \\
Surface runoff lag time [days]             & SURLAG     & *.bsn  & 1.00e+00   & 1.20e+01 & 4.00e+00  & 8 \\
Snowfall temperature  [$^{\circ}{\rm C}$]  & SFTMP      & *.bsn  & -5.00e+00  & 5.00e+00 & 1.00e+00  & 9 \\
\midrule
Snowmelt base temperature [$^{\circ}{\rm C}$]   & SMTMP  & *.bsn  & -5.00e+00 & 5.00e+00 & 5.00e-01 & 10\tnote{3} \\
Minimum melt factor for snow [$^{\circ}{\rm C}$]& SMFMN  & *.bsn  & 1.40e+00  & 6.90e+00 & 4.50e+00 & 11\tnote{3} \\
Snowpack temperature lag factor [-]             & TIMP   & *.bsn  & 1.00e-02  & 1.00e+00 & 1.00e+00 & 12\tnote{3} \\
Maximum melt factor for snow [$^{\circ}{\rm C}$]& SMFMX  & *.bsn  & 1.40e+00  & 6.90e+00 & 4.50e+00  & 13\tnote{3} \\
Manning's ``n'' value for overland flow [-]     & OV\_N  & *.hru  & 8.00e-03  & 6.00e-01          & 1.00e-01 & 14\tnote{3}\\
Deep aquifer percolation factor [-]             & RCHRG\_DP & *.gw& 0.00e+00     & 1.00e+00       & 5.00e-02 & 15\tnote{3} \\
Threshold water depth in the shallow aquifer for flow [mm]  & GWQMN  & *.gw & 0.00e+00 & 5.00e+03 & 0.00e+00 & 16\tnote{3} \\
Groundwater ``\emph{revap}'' coefficient [-]    & GW\_REVAP & *.gw   & 0.00e+00 & 2.00e-01        & 2.00e-02 & 17\tnote{3} \\
Groundwater delay time [days]                   & GW\_DELAY & *.gw   & 1.00e+00 & 1.00e+02        & 3.10e+01 & 18\tnote{3} \\
Moist soil albedo                               & SOL\_ALB  & *.sol  & 0.00e+00 & 1.00e-01        & 1.00e-02\tnote{2}   & 19\tnote{3} \\
Threshold water depth in the shallow aquifer for ``\emph{revap}'' [mm] & REVAVMN& *.gw & 1.00e+00 & 5.00e+02 & 1.00e+00 & 22\tnote{3} \\
Plant uptake compensation factor [-]            & EPCO      & *.bsn  & 1.00e-02 & 1.00e+00    & 1.00e+00 & 22\tnote{3} \\
Maximum canopy storage [mm H$_2$O]              & CANMX     & *.hru  & 0.00e+00 & 1.00e+01    & 0.00e+00 & 22\tnote{3} \\
\bottomrule
\end{tabular}
 \begin{tablenotes}
  \item[1] Sensitivity analysis based on LH-OAT (see Section~\ref{sec:sensitswat2005}).
  \item[2] Default values based on the study area information.
  \item[3] Insensitive parameters obtained from the LH-OAT analysis.
 \end{tablenotes}
\end{threeparttable}
}
\end{table}

\subsection{Interfacing \emph{hydroPSO} and SWAT-2005\label{sec:interfacingswat2005}}
The interaction between SWAT-2005 and \emph{hydroPSO} is shown in Figure~\ref{fig:swathydroPSO}. Here, SWAT-2005 is executed by \Verb+swat2005.exe+ (or \Verb+swat2005.out+ under GNU/Linux), which reads several input files (e.g. *.mgt, *.gw, *.sol, *.hru, *.bsn, and *.rte) containing the parameters to be calibrated. \Verb+swat2005.exe+ executes the SWAT-2005 model code and produces the *.rch file, which contains simulated discharges for defined river reaches. River discharges simulated by SWAT-2005 are then read by the \emph{hydroPSO} function \Verb+rch2zoo+, which transforms the time series of discharge values into a \Verb+zoo+ R object (\textit{\textbf{sim}}). Subsequently, the \emph{hydroGOF} R package (see \url{http://cran.r-project.org/web/packages/hydroGOF/}) is used to calculate a Nash-Sutcliffe Efficiency (NSE) \citep[see][]{nashsutcliffe1970} as goodness-of-fit measure (Note that loading the \emph{hydroGOF} R package gives the user a full suite of goodness-of-fit measures such as: root mean square error (rms), normalized rms (nrms), Pearson correlation coefficient, (r), coefficient of determination (R2), modified NSE (mNSE), index of agreement (d), coefficient of persistence (cp), percent bias (pbias), Kling-Gupta Efficiency (KGE) among others). NSE is used to assess the quality of the current parameter set (particles' positions) by \emph{hydroPSO}. Then, \emph{hydroPSO} updates the current particles' positions (parameter set) on the basis of the current NSE and the new updated parameter values (best particles' positions) are written into the corresponding files defined in \emph{ParamFiles.txt}.

\begin{figure}[t]
	\centering
	\noindent\includegraphics[width=0.65\textwidth]{./figures/swathydroPSO.pdf} 
	\caption{Interaction of \emph{hydroPSO} with SWAT-2005 and main I/O wrapper functions defined.}
	\label{fig:swathydroPSO}
\end{figure}

\subsection{Definition of \emph{ParamFiles.txt} and~\emph{ParamRanges.txt} files}
The basic interaction between \emph{hydroPSO} and SWAT-2005 is defined through the specification of, first, the names and location of the parameters to be calibrated and, second, the definition of meaningful parameter ranges. This information is provided by two (problem-specific) ASCII files, namely, \emph{ParamFiles.txt} and \emph{ParamRanges.txt}, which must be contained in the \Verb+./PSO.in+ folder. In general, if a sensitivity analysis is implemented resulting in the identification of (in)sensitive parameters, the \emph{hydroPSO} user will have to define two sets of interfacing files, one for the sensitivity analysis (most likely including all parameters considered) and other for the calibration stage (most likely including only sensitive parameters). In this study case, \emph{ParamFiles-Sens.txt} and \emph{ParamRanges-Sens.txt} are defined as the interfacing files used for the sensitivity analysis, which correspond to the full set of hydrology-related parameters listed in Table~\ref{tab:swatparams}. 

\begin{Verbatim}[frame=single,label=ParamFiles-Sens.txt,fontsize=\scriptsize]
ParameterNmbr  ParameterName  Filename       Row.Number Col.Start Col.End DecimalPlaces
1              CN2            000010001.mgt  11          4        16      5
1              CN2            000020001.mgt  11          4        16      5
2              ESCO           basins.bsn     13          4        16      3
3              SURLAG         basins.bsn     20          4        16      3 
4              RCHRG_DP       000010001.gw    9          1        16      7
4              RCHRG_DP       000020001.gw    9          1        16      7
5              GWQMN          000010001.gw    6          1        16      7
5              GWQMN          000020001.gw    6          1        16      7
6              GW_REVAP       000010001.gw    7          1        16      7
6              GW_REVAP       000020001.gw    7          1        16      7
7              REVAPMN        000010001.gw    8          1        16      7
7              REVAPMN        000020001.gw    8          1        16      7
8              GW_DELAY       000010001.gw    4          1        16      7
8              GW_DELAY       000020001.gw    4          1        16      7  
9              ALPHA_BF       000010001.gw    5          1        16      7 
9              ALPHA_BF       000020001.gw    5          1        16      7 
10             SOL_K          000010001.sol  11         28        39      5
10             SOL_K          000010001.sol  11         40        51      5
10             SOL_K          000010001.sol  11         52        63      5
10             SOL_K          000020001.sol  11         28        39      5 
10             SOL_K          000020001.sol  11         40        51      5
10             SOL_K          000020001.sol  11         52        63      5
11             SOL_AWC        000010001.sol  10         28        39      5
11             SOL_AWC        000010001.sol  10         40        51      5
11             SOL_AWC        000010001.sol  10         52        63      5
11             SOL_AWC        000020001.sol  10         28        39      5 
11             SOL_AWC        000020001.sol  10         40        51      5
11             SOL_AWC        000020001.sol  10         52        63      5 
12             CH_N2          000010000.rte   6          4        16      3
12             CH_N2          000020000.rte   6          4        16      3
13             CH_K2          000010000.rte   7          4        16      3
13             CH_K2          000020000.rte   7          4        16      3
14             OV_N           000010001.hru   5          4        16      3
14             OV_N           000020001.hru   5          4        16      3
15             SFTMP          basins.bsn      4          4        16      3
16             SMTMP          basins.bsn      5          4        16      3    
17             SMFMX          basins.bsn      6          4        16      3
18             SMFMN          basins.bsn      7          4        16      3
19             TIMP           basins.bsn      8          4        16      3
20             EPCO           basins.bsn     14          4        16      3
21             CANMX          000010001.hru   9          4        16      3
21             CANMX          000020001.hru   9          4        16      3
22             SOL_ALB        000010001.sol  17         28        39      5
22             SOL_ALB        000010001.sol  17         40        51      5
22             SOL_ALB        000010001.sol  17         52        63      5
22             SOL_ALB        000020001.sol  17         28        39      5 
22             SOL_ALB        000020001.sol  17         40        51      5
22             SOL_ALB        000020001.sol  17         52        63      5 
\end{Verbatim}

\begin{Verbatim}[frame=single,label=ParamRanges-Sens.txt,fontsize=\scriptsize]
ParameterNmbr  ParameterName  MinValue     MaxValue     
1              CN2            40           95
2              ESCO           0.01         1
3              SURLAG         1            12
4              RCHRG_DP       0            1.0
5              GWQMN          0            5000
6              GW_REVAP       0            0.2
7              REVAPMN        1            500
8              GW_DELAY       1            100
9              ALPHA_BF       0.01         0.99
10             SOL_K          0.001        1000
11             SOL_AWC        0.01         0.35
12             CH_N2          0.016        0.150  
13             CH_K2          0            200
14             OV_N           0.008        0.600
15             SFTMP          -5           5
16             SMTMP          -5           5
17             SMFMX          1.4          6.9
18             SMFMN          1.4          6.9       
19             TIMP           0.01         1
20             EPCO           0.01         1
21             CANMX          0            10
22             SOL_ALB        0            0.1
\end{Verbatim}

\subsection{Implementation Details and Results of the Calibration\label{sec:resultsswat2005}}
\subsubsection{Sensitivity Analysis\label{sec:sensitswat2005}}
As first step, a sensitivity analysis is performed on the 22 parameters listed in Table~\ref{tab:swatparams}. The \Verb+lhoat()+ \emph{hydroPSO} function allows the user to rank relevant parameters according to their impact on model predictions or performance using the Latin Hypercube One-factor-At-a-Time (LH-OAT) method developed by \citet{vangriensven+al2006}. LH-OAT works by taking $M$ LH sampling points ($M$ strata for each parameter) and then varying by a fraction $s$ each LH sampling point $D$ times, where $D$ is the number of parameters (i.e. problem dimensionality). For each LH sampling point a partial effect for each parameter is calculated and a final effect (impact on model predictions) is calculated by averaging these partial effects for each parameter. The method is very efficient requiring a total of $M(D+1)$ runs. Details of the sensitivity analysis implemented for SWAT-2005 are as follows:

\begin{enumerate}
\item Nash-Sutcliffe Efficiency (NSE) is used as a goodness-of-fit measure (\emph{hydroGOF} R package).

\item Period for the analysis corresponds to 01-Jan-1962 to 31-Dec-1970 using a daily time step.

\item The number of strata for the LH sampling was defined as $M=300$, whereas the fraction of variation was 10\%, i.e. $s=0.1$.

\item Observations used to assess the model performance are stored in the auxiliary file \Verb+SWAT_obs.txt+, whereas the auxiliary file \Verb+LHOAT-SWAT2005.R+ implements the sensitivity analysis as follows:

\begin{Verbatim}[frame=single,label=LHOAT-SWAT2005.R,fontsize=\scriptsize]
###Loading required libraries
library(hydroPSO)
library(hydroGOF)
library(hydroTSM)
library(SWAT2R)   # if not on CRAN, get it from \url{http://www.rforge.net/SWAT2R/}

###Definition of working directory: input, output and model files paths
model.drty <- "~/SWAT2005"             
setwd(model.drty)
param.ranges <- paste(model.drty,"/PSO.in/ParamRanges-Sens.txt",sep="")

###Period of analysis (see "file.cio" SWAT file)
Sim.Ini="1962-01-01"
Sim.Fin="1965-12-31"
gof.Ini="1962-01-01"
gof.Fin="1965-12-31"

###Goodness-of-fit function, either customized or pre-defined from hydroGOF
gof.FUN <- "NSE"
gof.FUN.args <- list()

###Getting the OBSERVATIONS
q.obs <- read.zoo("SWAT_obs.txt")

###Arguments for the model to be assessed
model.FUN.args=list(
   model.drty=model.drty,
   param.files=paste(model.drty,"/PSO.in/ParamFiles-Sens.txt",sep=""),
   #exe.fname="./swat2005.out", # GNU/Linux
   exe.fname="swat2005.exe",    # Windows XP/Vista/7/...
   #verbose=TRUE,               # To see on the screen which parameters are changed
   #stdout="",      
   stderr=FALSE,
   ###Function for reading the simulated equivalents                  
   out.FUN="read_rch",
   out.FUN.args=list(
      file="output.rch",
      col.names="FLOW_OUTcms",
      out.type="Q",                     
      rchID=1,
      Date.Ini=Sim.Ini,
      Date.Fin=Sim.Fin,
      tstep="daily"), ###END out.FUN.args                         
   ###Function assessing the simulated equivalents against the observations                  
   gof.FUN=gof.FUN,
   gof.FUN.args=gof.FUN.args
   gof.Ini=gof.Ini,
   gof.Fin=gof.Fin,
   obs=q.obs,
) ###END model.FUN.args
           
###Main Latin-Hypercube One-factor-At-a-Time Sensitivity Analysis
lhoat(
   fn="hydromod",
   model.FUN="hydromod",
   model.FUN.args=model.FUN.args,
   control=list(
      N=300,
      f=0.1,         
      drty.out="LH_OAT",
      param.ranges=param.ranges,                     
      gof.name="GoF",
      do.plots=FALSE,
      write2disk=TRUE,
      verbose= TRUE) ###END control options
) ###END lhoat
\end{Verbatim}

\item This sensitivity analysis requires a total of 6900 iterations ($M=300$ and $D=22$). In \Verb+LHOAT-SWAT2005.R+ we define the keyword \Verb+NSE+ from \emph{hydroGOF} as goodness-of-fit measure as well as \Verb+SWAT_obs.txt+ as the file containing the daily discharge observations. Within the arguments for the model code to be assessed, we must define the location of the \Verb+ParamFiles.txt+ and the name of the executable file (\Verb+swat2005.out+). In addition, we specify the function for reading the simulated discharges (\Verb+out.FUN+) as \Verb+rch2zoo+, whereas the assessment of each simulation is done through \Verb+gof.FUN="NSE"+. For the \Verb+lhoat()+ function we first define the keyword \Verb+hydromod+, which indicates that an external model code (i.e. not a pre-defined test function coded in \emph{hydroPSO}) will be analysed. Arguments \Verb+N=300+, \Verb+f=0.1+, and \Verb+drty.out=LH_OAT+ are used to define the number of strata, the fraction of variation for each parameter, and the name of the folder where results will be saved, respectively. \Verb+lhoat()+ produces the file \Verb+LH_OAT-Ranking.txt+, which contains a ranking of parameters according to their relative importance.

\begin{Verbatim}[frame=single,label=LH\_OAT-Ranking.txt,fontsize=\scriptsize]
RankingNmbr ParameterName RelativeImportance
1           ALPHA_BF      5.707630e+02
2           CH_N2         2.238171e+02
3           CN2           1.874606e+02
4           SOL_K         1.433732e+02
5           SOL_AWC       1.298079e+02
6           CH_K2         9.871332e+01
7           ESCO          9.403977e+01
8           SURLAG        6.890757e+01
9           SFTMP         5.144755e+01
10          SMTMP         2.285713e+01
11          SMFMN         1.619080e+01
12          TIMP          6.051893e+00
13          SMFMX         3.735775e+00
14          OV_N          2.607991e+00
15          RCHRG_DP      4.295568e-01
16          GWQMN         3.301034e-01
17          GW_REVAP      1.705301e-01
18          GW_DELAY      6.303209e-02
19          SOL_ALB       1.192648e-02
20          REVAPMN       4.581639e-03
22          EPCO          0.000000e+00
22          CANMX         0.000000e+00
\end{Verbatim}

\item The ranking obtained from the sensitivity analysis is included in the last column of Table~\ref{tab:swatparams}. We see from this table that 9 parameters are identified as sensitive using a NSE as goodness-of-fit measure for daily discharge simulations in the period 01-Jan-1962 to 31-Dec-1970 (several trials showed that the tenth parameter, \Verb+SMTMP+, is relatively insensitive, and for sake of clarity, we have excluded it from the subsequent analysis). In general, this ranking is in agreement with previous research \citep[see e.g.][]{holvoet+al2005,muletanicklow2005,vanLiew+al2005,vangriensven+al2006,kannan+al2007,vanLiew+al2007}, and this subset of parameters constitute the basis for the calibration of the SWAT-2005 model. The resulting files (\Verb+ParamFiles.txt+ and \Verb+ParamRanges.txt+) used to interface \emph{hydroPSO} and SWAT-2005 in the calibration stage are as follows:

\end{enumerate}

\begin{Verbatim}[frame=single,label=ParamFiles.txt,fontsize=\scriptsize]
ParameterNmbr  ParameterName  Filename       Row.Number Col.Start Col.End DecimalPlaces
1              CN2            000010001.mgt  11          4        16      5
1              CN2            000020001.mgt  11          4        16      5
2              ESCO           basins.bsn     13          4        16      3
3              SURLAG         basins.bsn     20          4        16      3 
4              ALPHA_BF       000010001.gw    5          1        16      7 
4              ALPHA_BF       000020001.gw    5          1        16      7 
5              SOL_K          000010001.sol  11         28        39      5
5              SOL_K          000010001.sol  11         40        51      5
5              SOL_K          000010001.sol  11         52        63      5
5              SOL_K          000020001.sol  11         28        39      5 
5              SOL_K          000020001.sol  11         40        51      5
5              SOL_K          000020001.sol  11         52        63      5
6              SOL_AWC        000010001.sol  10         28        39      5
6              SOL_AWC        000010001.sol  10         40        51      5
6              SOL_AWC        000010001.sol  10         52        63      5
6              SOL_AWC        000020001.sol  10         28        39      5 
6              SOL_AWC        000020001.sol  10         40        51      5
6              SOL_AWC        000020001.sol  10         52        63      5 
7              CH_N2          000010000.rte   6          4        16      3
7              CH_N2          000020000.rte   6          4        16      3
8              CH_K2          000010000.rte   7          4        16      3
8              CH_K2          000020000.rte   7          4        16      3
9              SFTMP          basins.bsn      4          4        16      3
\end{Verbatim}

\begin{Verbatim}[frame=single,label=ParamRanges.txt,fontsize=\scriptsize]
ParameterNmbr  ParameterName  MinValue     MaxValue     
1              CN2            40           95
2              ESCO           0.01         1
3              SURLAG         1            12
4              ALPHA_BF       0.01         0.99
5              SOL_K          0.001        1000
6              SOL_AWC        0.01         0.35
7              CH_N2          0.016        0.150  
8              CH_K2          0            200
9              SFTMP          -5           5
\end{Verbatim}

\subsubsection{Calibration\label{sec:calibswat2005}}
After obtaining a ranking with the most sensitive parameters, the calibration of the river discharges for the EGA headwater catchment proceeded as follows:

\begin{enumerate}
\item Files interfacing \emph{hydroPSO} and SWAT-2005 (i.e. \Verb+ParamFiles.txt+ and~\Verb+ParamRanges.txt+) are stored in the \Verb+./PSO.in+ folder, within the directory containing all the required files to run SWAT-2005, which for this tutorial is \Verb+./SWAT2005+.

\item Several auxiliary files (described below) are included in \Verb+./SWAT2005+:

\begin{Verbatim}[frame=single,label=Auxiliary Files in SWAT2005,fontsize=\small]
hydroPSO-SWAT2005.R -> Main R script to run hydroPSO
SWAT_obs.txt -> ASCII file with the discharge observations
\end{Verbatim}

As previously explained (see Section~\ref{sec:sensitswat2005}), the file \Verb+LH_OAT-Ranking.txt+ is saved in the folder \Verb+./SWAT2005/LH_OAT+.

\item The setup for the calibration of the Ega headwater catchment is defined in the \Verb+hydroPSO-SWAT2005.R+ script. By default all the results from hydroPSO are saved into the \Verb+PSO.out+ folder, however, this can be redefined by using the \Verb+drty.out+ argument.

\begin{Verbatim}[frame=single,label=hydroPSO-SWAT2005.R,fontsize=\scriptsize]
####################################################################################
## Example to interface SWAT-2005 with hydroPSO. This script allows hydroPSO to    #
## take control of the execution of SWAT-2005 through the definition of a batch    #
## file (run_me.bat) and a series of simple I/O R scripts                          #
##                                                                                 #
## Part of the hydroPSO R package                                                  #
## http://www.rforge.net/hydroPSO/ http://cran.r-project.org/web/packages/hydroPSO #
## Copyright 2011-2012 Mauricio Zambrano-Bigiarini & Rodrigo Rojas                 #
## Distributed under GPL 2 or later                                                #
##                                                                                 #
## Created by Mauricio Zambrano-Bigiarini and Rodrigo Rojas. 26-Oct-2011           #
## Last saved: 13-Feb-2012                                                         #
####################################################################################

###Loading required libraries
library(hydroPSO)
library(hydroGOF)
library(hydroTSM)
library(SWAT2R)    # if not on CRAN, get it from \url{http://www.rforge.net/SWAT2R/}

###Definition of working directory: input, output and model files paths
model.drty <- "~/SWAT2005"
setwd(model.drty)

###Period of analysis
Sim.Ini="1962-01-01"
Sim.Fin="1965-12-31"
gof.Ini="1962-01-01"
gof.Fin="1965-12-31"

###Goodness-of-fit function, either customized or pre-defined from hydroGOF
gof.FUN <- "NSE"
gof.FUN.args <- list()

###Getting the OBSERVATIONS
q.obs <- read.zoo("SWAT_obs.txt")

###MAIN model function
model.FUN.args=list(
   model.drty=model.drty,
   param.files=paste(model.drty,"/PSO.in/ParamFiles.txt",sep=""), 
   #exe.fname="./swat2005.out", # GNU/Linux
   exe.fname="swat2005.exe",    # Windows XP/Vista/7/...
   #verbose=FALSE,              # To see on the screen which parameters are changed
   #stdout="",      
   stderr=FALSE,
   ###Function for reading the simulated equivalents
   out.FUN="read_rch",
   out.FUN.args=list(
      file="output.rch",
      col.names="FLOW_OUTcms",
      out.type="Q",
      rchID=1,
      Date.Ini=Sim.Ini,
      Date.Fin=Sim.Fin,
      tstep="daily",
      verbose=FALSE), ###END out.FUN.args
   ###Function for assessing the simulated equivalents against the observations
   gof.FUN=gof.FUN,
   gof.FUN.args=gof.FUN.args,
   gof.Ini=gof.Ini,
   gof.Fin=gof.Fin,
   obs=q.obs,
) ###END model.FUN.args

###MAIN PSO ALGORITHM
###For hydroPSO fine-tuning parameters, see Zambrano-Bigiarini and Rojas,2012
set.seed(100)
hydroPSO(
   fn="hydromod",
   model.FUN="hydromod",        
   model.FUN.args=model.FUN.args,
   control=list(
      param.ranges="ParamRanges-09params-sub090.txt",
      MinMax="max",
      npart=20,
      maxit=2000,
      lambda=1,
      c2=0.5+log(2),
      use.IW=TRUE,IW.type="linear",IW.w=1/(2*log(2)),IW.exp=1,     
      use.TVc1=TRUE,TVc1.type="non-linear",TVc1.rng=c(1.28,1.05),TVc1.exp=1.5,
      use.TVlambda=TRUE,TVlambda.type="linear",TVlambda.rng=c(1.0,0.5),TVlambda.exp=
      1,
      topology="random",K=3,
      boundary.wall="reflecting",
      write2disk=TRUE,
      REPORT=5,
      verbose=TRUE
   ) ###END control options
) ###END MAIN hydroPSO ALGORITHM
\end{Verbatim}

\item In the \Verb+hydroPSO-SWAT2005.R+ script we first load all the required libraries, setup the working directory, and define the simulation period as well as the period for calculating the goodness-of-fit measure (these two could be different depending on the nature of the application). To assess the performance of each particle in \emph{hydroPSO} we use the Nash-Sutcliffe Efficiency (NSE) implemented in the \emph{hydroGOF} package as goodness-of-fit measure. Discharge observations used to assess the corresponding simulated equivalents are read as a \Verb+zoo+ object in R (to take advantage of time attributes) from the \Verb+SWAT_obs.txt+ ASCII file. Then, we define all arguments related to the main model code to be calibrated. Note that these arguments are identical as for the sensitivity analysis (\Verb+LHOAT-SWAT2005.R+) and, so, they will not be repeated here. For the main \emph{hydroPSO} algorithm, the keyword \Verb+hydromod+ \textbf{must} be used for the argument \Verb+fn+ when a function different from a predefined test function is calibrated. This will indicate \emph{hydroPSO} to expect for external files containing the model executable(s), input(s), an ouput(s) files. For this example, we use the traditional \Verb+pso+ (default) algorithm to maximize (\Verb+MinMax="max"+) the NSE calculated by \emph{hydroGOF} (\Verb+gof.FUN="NSE"+). A swarm of 20 particles (\Verb+npart=20+) considering 2000 iterations (\Verb+maxit=2000+) for the algorithm is defined. A constant inertia weight equal to \Verb+1/(2*log(2))+ and a non-linear (\Verb+TVc1.type="non-linear"+) time-variant cognition coefficient ($c_1$) (\Verb+use.TVc1=TRUE+) in the range [1.28,1.05] with exponent 1.5 (\Verb+TVc1.exp=1.5+) are defined. In addition, we improve on the definition of the factor clamping the velocities (\Verb+lambda+) by using a linear variation between [1.0,0.5]. Particles interact following the \Verb+random+ topology with 3 informants. Finally, results are saved by default in the folder \Verb+./PSO.out+.

\item Plotting the results (Figures~\ref{fig:convmeas-swat} to~\ref{fig:simvsobs_quant-swat}). Using the \Verb+plot_results()+ function results are saved directly to the folder \Verb+./PSO.out/pngs+:
<<eval=FALSE>>=
plot_results(do.png=TRUE)
@

Although it is not the aim of this tutorial to provide an extensive analysis of the hydrological calibration for the Ega headwater catchment, we briefly discuss the results obtained from \emph{hydroPSO}. Figure~\ref{fig:convmeas-swat} shows the evolution of the the Gbest, i.e. the Nash-Sutcliffe Efficiency, as a function of the iteration number. We see an initial exploration phase (up to ca. iter=120) that stabilizes after iteration 200 around a value of NSE=0.77. At the same time, the Normalized Swarm Radius indicates a clear convergence to the attraction zone around this optimum. Although not shown here, several trials (including different number of iterations and particles for the swarm) indicate that this solution is most likely the global optimum for the calibration. 

A dotty-plot for the different (sensitive) parameters listed in Table~\ref{tab:swatparams} is shown in Figure~\ref{fig:dottyplots-swat}. >From this figure we see a good identification for all parameters, except ESCO and SURLAG, which show a relatively flat response surface. Figure~\ref{fig:3Ddottyplots-swat} complements the previous one by showing a 2-Dimensional projection of the goodness-of-fit surface response (NSE) for different parameter pairs. Figure~\ref{fig:ParamPairs-swat}, in turn, summarizes the interaction among all (sensitive) parameters listed in Table~\ref{tab:swatparams}. Here a clear correlation between the NSE and CH\_N2, CH\_K2 is observed, whereas a statistically significant cross-correlation is observed between CH\_K2 (CH\_N2) and ALPHA\_BF. Empirical Cumulative Distribution Functions (ECDFs) (Figure~\ref{fig:ecdfs-swat}) and histograms (Figure~\ref{fig:hist-swat}) for the parameters show a good specification with reduced uncertainty around the median and some for the extreme quantiles. Figures~\ref{fig:gofperiter-swat},~\ref{fig:paramsperrun-swat}, and~\ref{fig:velsperrun-swat} provide, in turn, useful information to assess the performance and convergence of the NSE, parameters, and velocities per iteration number. By analysing these figures we conclude that the \emph{hydroPSO} package converged to a suitable attraction zone.

Figure~\ref{fig:simvsobs-swat} provides the daily and monthly time-series summarizing the calibration together with a series of performance indicators. In general, we see a slight underestimation of recession and peak-flows (PBIAS=-2.8\%) with a good agreement of average flows (MAE=4.67) and a final optimised Nash-Sutcliffe Efficiency of 0.78. At the same time, Figure~\ref{fig:simvsobs_corr-swat} shows a scatter plot of simulated versus observed daily discharges. Finally, Figure~\ref{fig:simvsobs_quant-swat} shows different user-defined quantiles including an estimation of the percentage bias for the specified quantiles.

\end{enumerate}

\clearpage

\begin{sidewaysfigure}[!ht]
	\centering
	\noindent\includegraphics[width=\textwidth]{./figures/SWAT2005/ConvergenceMeasures.png} 
	\caption{Evolution of the Global Optimum (GOptim) and the Normalized Swarm Radius (NSR) versus iteration number for the calibration of the Ega headwater catchment.}
	\label{fig:convmeas-swat}
\end{sidewaysfigure}

\clearpage

\begin{sidewaysfigure}[!ht]
	\centering
	\noindent\includegraphics[width=\textwidth]{./figures/SWAT2005/Params_DottyPlots.png} 
	\caption{Dotty-plots for the (sensitive) parameters listed in Table~\ref{tab:swatparams}. Vertical and horizontal coloured lines show the location of the highest goodness-of-fit value (Nash-Sutcliffe Efficiency).}
	\label{fig:dottyplots-swat}
\end{sidewaysfigure}

\clearpage

\begin{sidewaysfigure}[!ht!]
	\centering
	\noindent\includegraphics[width=\textwidth]{./figures/SWAT2005/Params_dp3d.png} 
	\caption{2-dimensional projected dotty-plots highlighting the interaction among the first seven (sensitive) parameters listed in Table~\ref{tab:swatparams}.}
	\label{fig:3Ddottyplots-swat}
\end{sidewaysfigure}

\clearpage

\begin{sidewaysfigure}[!ht]
	\centering
	\noindent\includegraphics[width=\textwidth]{./figures/SWAT2005/Params_Pairs.png} 
	\caption{Matrix summarizing the cross-correlation, histograms and statistical significance of the correlation for the (sensitive) parameters listed in Table~\ref{tab:swatparams}.}
	\label{fig:ParamPairs-swat}
\end{sidewaysfigure}

\clearpage

\begin{sidewaysfigure}[!ht]
	\centering
	\noindent\includegraphics[width=\textwidth]{./figures/SWAT2005/Params_ECDFs.png} 
	\caption{Empirical Cumulative Distribution Functions (ECDFs) for the (sensitive) parameters listed in Table~\ref{tab:swatparams}. Vertical and horizontal grey dashed-line indicate the location of a user-defined percentile.}
	\label{fig:ecdfs-swat}
\end{sidewaysfigure}

\clearpage

\begin{sidewaysfigure}[!ht]
	\centering
	\noindent\includegraphics[width=\textwidth]{./figures/SWAT2005/Params_Histograms.png} 
	\caption{Histograms for the (sensitive) parameters listed in Table~\ref{tab:swatparams}. Vertical red lines show the location of the highest goodness-of-fit value (Nash-Sutcliffe Efficiency).}
	\label{fig:hist-swat}
\end{sidewaysfigure}

\clearpage

\begin{sidewaysfigure}[!ht]
	\centering
	\noindent\includegraphics[width=\textwidth]{./figures/SWAT2005/Particles_GofPerIter.png} 
	\caption{Nash-Sutcliffe Efficiency for all 20 particles for 2000 iterations.}
	\label{fig:gofperiter-swat}
\end{sidewaysfigure}

\clearpage

\begin{sidewaysfigure}[!ht]
	\centering
	\noindent\includegraphics[width=\textwidth]{./figures/SWAT2005/Params_ValuesPerRun.png} 
	\caption{Convergence of the different (sensitive) parameters as a function of the iteration number.}
	\label{fig:paramsperrun-swat}
\end{sidewaysfigure}

\clearpage

\begin{sidewaysfigure}[!ht]
	\centering
	\noindent\includegraphics[width=\textwidth]{./figures/SWAT2005/Velocities_ValuePerRun.png} 
	\caption{Convergence of the velocities for each (sensitive) parameter as a function of the iteration number.}
	\label{fig:velsperrun-swat}
\end{sidewaysfigure}

\clearpage

\begin{sidewaysfigure}[!ht]
	\centering
	\noindent\includegraphics[width=\textwidth]{./figures/SWAT2005/ModelOut_BestSim_vs_Obs-ggof.png} 
	\caption{Simulated versus Observed discharges at the station Q071 (see Figure~\ref{fig:fega01}). Upper panels show daily calibrated time series and summary box. Lower panels show monthly (aggregated) time series and summary box.}
	\label{fig:simvsobs-swat}
\end{sidewaysfigure}

\clearpage

\begin{sidewaysfigure}[!ht]
	\centering
	\noindent\includegraphics[width=\textwidth]{./figures/SWAT2005/ModelOut_BestSim_vs_Obs-Corr.png} 
	\caption{Scatter plot of best simulated versus observed daily discharges at the station Q071 (see Figure~\ref{fig:fega01}).}
	\label{fig:simvsobs_corr-swat}
\end{sidewaysfigure}

\clearpage

\begin{sidewaysfigure}[!ht]
	\centering
	\noindent\includegraphics[width=\textwidth]{./figures/SWAT2005/ModelOut_Quantiles.png} 
	\caption{ECDFs for user-defined quantiles (5, 95 and 95). Vertical dashed-line represents the observed quantile.}
	\label{fig:simvsobs_quant-swat}
\end{sidewaysfigure}

\clearpage

\section{Calibration of a Groundwater Flow Model Using \emph{hydroPSO}\label{sec:mf2005}}
\subsection{Groundwater System and Conceptualization\label{sec:gwmodel}}
The model to be calibrated is termed ``M2'' and is similar to the model implemented in \citet{rojas2010a}. The groundwater system is described by an unconfined aquifer which receives lateral groundwater recharges at the eastern boundary and over all domain through deep fissures in basement rocks. The system exchanges groundwater with contiguous aquifers at the western and southern boundaries, whereas at the northern boundary it shows a groundwater divide. Main outputs of groundwater from the system corresponds to high transpiration rates from forested areas and high evaporation rates from ``playas''. The groundwater system is assumed to be under steady-state conditions. An schematic representation of the system is shown in Figure~\ref{fig:f02vign}.

This groundwater system is conceptualized as a one-layer aquifer, with the northern and southern interaction with external forcings expressed as constant-head boundaries using the BAS6 package of MF2005. Recharge mechanisms are expressed by lateral constant flux and spatially-distributed recharge rates using the WEL and RCH packages of MF2005, respectively. We consider 22 hydraulic conductivity zones obtained from \citet{rojas2007} implemented in the LPF package, one transpiration zone defined as negative rates using the RCH package and one evaporation zone implemented in the EVT package. In total, 30 parameters are considered for the calibration of model M2. The definition of parameters as well as their feasible ranges to implement \emph{hydroPSO} are shown in Table~\ref{tab:M2pars}. In addition, we consider 42 observation wells (evenly) distributed in the modelled domain for calibration purposes.

\begin{table}[ht]
\caption{Parameters used to calibrate model M2 with the \emph{hydroPSO} package.}
\centering
\resizebox{24pc}{!}{
\begin{tabular}{llcc}
\toprule
Parameter                                        &             & \multicolumn{2}{c}{Range} \\
\cmidrule{3-4}
                                                 &             & Min & Max \\
\midrule
Recharge (Lateral fluxes) [m$^{3}$~d$^{-1}$]     & RECH      & 0    & 345600\\
Recharge from basement rocks [m$^{3}$~d$^{-1}$]  & RECH\_BAS & 0    & 172800\\
Transpiration forested areas [m$^{3}$~d$^{-1}$]  & TRANSP    & 0    & 172800\\
Discharge to eastern aquifers [m$^{3}$~d$^{-1}$] & NORIA     & 0    & 86400 \\
Evaporation rate [m~d$^{-1}$]                    & EVTR      & 0    & 0.01  \\
Extinction depth  [m]                            & EXTD      & 0    & 20    \\
Elevation constant head north [m]                & CH\_N     & 1075 & 1120  \\
Elevation constant head south [m]                & CH\_S     & 875  & 920   \\
Hydraulic conductivity for 22 zones [m~d$^{-1}$] & $K$       & 0    & 100   \\
\bottomrule
\end{tabular}
}
\label{tab:M2pars}
\end{table}

\begin{figure}[ht]
	\centering
	\noindent\includegraphics[width=0.5\textwidth]{./figures/f02vign.pdf} 
	\caption{Groundwater system conceptualization for model ``M2''. Note that M2 is set up with 22 hydraulic conductivity zones and 42 observation wells.}
	\label{fig:f02vign}
\end{figure}

\subsection{Interfacing \emph{hydroPSO} and MF2005 and ZB\label{sec:interfacingmf2005}}
The interaction between \emph{hydroPSO} and M2 (MF2005/ZB) is depicted in Figure~\ref{fig:f03vign}. \emph{run\_me.bat} is a simple batch script executing programmes \Verb+preproc+, \Verb+mf2005+ and \Verb+zonebud_hydroPSO+ sequentially. \Verb+preproc+ is a simple read/write FORTRAN code reading the \emph{pre\_param.txt} file for M2, which is an ASCII file containing updated parameter values produced by \emph{hydroPSO} after each iteration. \Verb+preproc+ is problem-specific and copies the (updated) parameter values in the files M2.BA6, M2.EVT, M2.LPF, M2.RCH and M2.WEL, which are the files containing the parameters for M2. Therefore, for a different groundwater model possibly having different conductivity zones, geometry, boundary conditions, etc., it will be necessary to adapt \Verb+preproc+ to that particular problem calibration. Special care must be taken in reading parameters as reported in the \emph{pre\_param.txt} file, whose order is defined by the user through the file \emph{ParamRanges.txt}. Subsequently, \Verb+mf2005+ executes MF2005 for the ``Name File'', M2.NAM. MF2005 produces a summary and the main results of the groundwater flow model (heads and global flow components) in files M2.LST, M2.BUD and M2.HED. Finally, \Verb+zonebud_hydroPSO+ calculates the balance for each specific ``budget'' zone defined in the M2.ZON file and saves the results into the M2.BAL file. \Verb+zonebud_hydroPSO+ is a modified version of the original ZB code where keyboard input is skipped by using pre-defined (hard-coded) default options.

\begin{figure}[t]
	\centering
	\noindent\includegraphics[width=0.6\textwidth]{./figures/f03vign.pdf} 
	\caption{Interaction of \emph{hydroPSO} with MF2005/ZB (M2) and main I/O wrapper functions defined.}
	\label{fig:f03vign}
\end{figure}

\subsection{Definition of \emph{ParamFiles.txt} and \emph{ParamRanges.txt} files\label{sec:PSOin}}
Two basic pieces of information are required to interface M2 and \emph{hydroPSO}. First, the names and location of the (multiple) parameters to be calibrated, together with specific location and decimal positions. Second, feasible and physically meaningful parameter ranges. This information is entered in two text files, \emph{ParamFiles.txt} and \emph{ParamRanges.txt}, which must be stored in the subdirectory \Verb+./PSO.in+. Note that care must be taken in numbering and naming the parameters as they require to be consistent in both files.

\begin{Verbatim}[frame=single,label=ParamFiles.txt,fontsize=\scriptsize]
ParameterNmbr ParameterName Filename      Row.Number Col.Start Col.End DecimalPlaces
1             HK_1          pre_param.txt 2          1         20      3
2             HK_2          pre_param.txt 3          1         20      3
3             HK_3          pre_param.txt 4          1         20      3
4             HK_4          pre_param.txt 5          1         20      3
5             HK_5          pre_param.txt 6          1         20      3
6             HK_6          pre_param.txt 7          1         20      3
7             HK_7          pre_param.txt 8          1         20      3
8             HK_8          pre_param.txt 9          1         20      3
9             HK_9          pre_param.txt 10         1         20      3
10            HK_10         pre_param.txt 11         1         20      3
11            HK_11         pre_param.txt 12         1         20      3
12            HK_12         pre_param.txt 13         1         20      3
13            HK_13         pre_param.txt 14         1         20      3
14            HK_14         pre_param.txt 15         1         20      3
15            HK_15         pre_param.txt 16         1         20      3
16            HK_16         pre_param.txt 17         1         20      3
17            HK_17         pre_param.txt 18         1         20      3
18            HK_18         pre_param.txt 19         1         20      3
19            HK_19         pre_param.txt 20         1         20      3
20            HK_20         pre_param.txt 21         1         20      3
21            HK_21         pre_param.txt 22         1         20      3
22            HK_22         pre_param.txt 23         1         20      3
23            R_TRANSP      pre_param.txt 24         1         20      4
24            R_BSMNT       pre_param.txt 25         1         20      4
25            R_CHN         pre_param.txt 26         1         20      4
26            R_CHS         pre_param.txt 27         1         20      4
27            R_EVTR        pre_param.txt 28         1         20      8
28            R_EXTD        pre_param.txt 29         1         20      4
29            R_RECH        pre_param.txt 30         1         20      4
30            R_NOR         pre_param.txt 31         1         20      4
\end{Verbatim}

\begin{Verbatim}[frame=single,label=ParamRanges.txt,fontsize=\scriptsize]
ParameterNmbr ParameterName MinValue MaxValue
1             HK_1          0        100
2             HK_2          0        100
3             HK_3          0        100
4             HK_4          0        100
5             HK_5          0        100
6             HK_6          0        100
7             HK_7          0        100
8             HK_8          0        100
9             HK_9          0        100
10            HK_10         0        100
11            HK_11         0        100
12            HK_12         0        100
13            HK_13         0        100
14            HK_14         0        100
15            HK_15         0        100
16            HK_16         0        100
17            HK_17         0        100
18            HK_18         0        100
19            HK_19         0        100
20            HK_20         0        100
21            HK_21         0        100
22            HK_22         0        100
23            R_TRANSP      0        172800
24            R_BSMNT       0        172800
25            R_CHN         1075     1120
26            R_CHS         875      920
27            R_EVTR        0        0.01
28            R_EXTD        0        20
29            R_RECH        0        345600
30            R_NOR         0        86400
\end{Verbatim}

\subsection{Basic I/O Wrapper Functions\label{sec:wrappers}}
For a successful calibration a number of observations are required for comparison against the simulated equivalents and, as such, they constitute the basis for the calculation of the objective function. For MF2005, we can define observations for a series of flow processes, e.g. specified-head flows, drains, rivers, groundwater heads, streams, etc., see \citet{mf2kobs}. For model M2, however, we employ 42 groundwater head observations contained in the M2.HOB file, which are read through a simple R function (\emph{read.hobs.R}). As explained later, \emph{read.hobs.R} is called only once and is not necessarily required. We include it to illustrate how additional observations for other flow components can be read, stored in an R object and used for calculating the objective function.

\begin{Verbatim}[frame=single,label=read.hobs.R,fontsize=\scriptsize]
read.hobs <- function(fname="M2.HOB",ncol=9,skip=2) {
  x <- read.table(file=fname,skip=skip,header=FALSE)
  x <- x[,ncol]
  return(x) }
\end{Verbatim}

The main I/O function to interface \emph{hydroPSO} and M2 (MF2005/ZB) is \emph{read.hsim.R}. This function reads simulated groundwater heads, global groundwater balance components and residuals, and calculates a customized goodness-of-fit measure as objective function. For this case, we read both simulated heads and calculated residuals from the M2.LST file. Alternatively, we could read simulated groundwater heads from the M2.HED file (for specific well locations), however, this does not allow us to read in one-step the global groundwater balance components available in the M2.LST file. By directly reading the residuals as reported in the M2.LST, we avoid having to read the groundwater head observations contained in the M2.HOB file.

At the same time, \emph{read.hsim.R} calculates a Gaussian likelihood measure $(L)$ using,

\begin{equation}\label{eq:gauss}
L=(2\pi)^{-N/2}\left|C\right|^{-1/2} \exp \left(-\frac{1}{2}\left(h_{sim}-h_{obs}\right)^{\emph{T}}\emph{C}^{-1}\left(h_{sim}-h_{obs}\right)\right)
\end{equation}

\noindent where $C$ is the covariance matrix of the observed system variables, $N$ is the number of observations, and the likelihood for the corresponding \emph{hydroPSO} iteration (i.e. parameter set) is obtained using a product inference function \citep[see, e.g.,][]{rojas2008}. Note that alternative formulations can be implemented as objective functions, however, the current version of \emph{hydroPSO} works \underline{only} with single-objective functions. 

Finally, \emph{read.hsim.R} writes the calculated likelihood, which is processed by \emph{hydroPSO} to assess the quality of the particles' positions, and the global groundwater balance components to simple ASCII files, \Verb+lik_gauss.txt+ and \Verb+WBAL.txt+, respectively.

\begin{Verbatim}[frame=single,label=read.hsim.R,fontsize=\scriptsize]
read.hsim <- function(fname="M2.LST",nobs=42) {
sim <- rep(NA,nobs)
lik <- NA
out <- rep(NA,7)
L <- 0
x <- readLines(fname)
stg <- " HEAD AND DRAWDOWN OBSERVATIONS"
n <- which(x==stg)
L <- length(n)

if (L > 0) {
  suppressWarnings(tmp <- read.table(file=fname,skip=n+3,header=FALSE,nrows=nobs,colClasses
  =c("NULL","NULL","numeric","numeric"),fill=TRUE,na.strings="OMITTED"))
  sim <- as.numeric(tmp[,1])  
  res1 <- as.numeric(tmp[,2]) 
  na.index <- which(is.na(sim))
  
  if ((length(sim)==nobs) & (length(na.index)==0)) {
    # Gaussian likelihood (stdev = 10 same for MCMC analysis Rojas et al. 2010)
    gauss1 <- 2*pi
    gauss2 <- 10*sqrt(gauss1)
    gauss3 <- 1/gauss2
    gauss4 <- 2*(10^2)
    res2 <- res1^2
    lik1 <- gauss3*exp(-(res2/gauss4))
    lik2 <- prod(lik1)
    lik <- lik2^(1/nobs) #likelihood using "product" inference function (Rojas et al. 2010)
	
	  system2("zonbud_hydroPSO.exe")
  stg <- "  VOLUMETRIC BUDGET FOR ENTIRE MODEL AT END OF TIME STEP  1 IN STRESS PERIOD   1"
    n <- which(x==stg)         
    L <- length(n)             
    if (L > 0) {
      suppressWarnings(tmp <- read.table(file=fname,skip=n+11,header=FALSE,nrows=9,fill=TRU
      E,stringsAsFactors=FALSE))
      rech <-as.numeric(tmp[1,3])
      evap <-as.numeric(tmp[8,3])
      transp <-as.numeric(tmp[9,3])
      out1 <- c(rech,evap,transp )
      names(out1) <- c("rech","evap","transp")
      out2 <- read.wbal("M2.BAL")
      out <- c(out1, out2)
    }
  } else {
      sim <- rep(NA,nobs)
      lik <- NA
      out <- rep(NA,7)
    }
}
# Adding the results of the water balance to "WBAL.txt"
wb.Text.file <- file("WBAL.txt","a")
writeLines(as.character(out),wb.Text.file,sep=" ")
writeLines("",wb.Text.file)
close(wb.Text.file)   
write(lik,"lik_gauss.txt")
return(sim) }
\end{Verbatim}

In principle, using \emph{read.hsim.R} and correctly defining the \emph{ParamFiles.txt} file, should suffice for interfacing \emph{hydroPSO} and M2 (MF2005/ZB). However, to consider alternative ``goodness-of-fit'' measures and/or observations might require using \emph{read.hobs.R}.

In addition, for this tutorial we develop an R script to read the results from the ZB program. \emph{read.wbal.R} reads the results for 4 ``budget'' zones defined in the M2.ZON file, and saved in the M2.BAL file by \Verb+zonebud_hydroPSO+. These flows are recharge due to deep fissures in basement rocks (\Verb+rechdeep+), outflows at the aquifer's southern cross-section (\Verb+cgordo+), (point) southernmost incoming lateral flux (\Verb+chaca+), and outflows to western aquifers (\Verb+noria+). These results are stored in an R object (\Verb+out+), which is saved in the WBAL.txt file by the \emph{read.hsim.R} script.

\begin{Verbatim}[frame=single,label=read.wbal.R,fontsize=\scriptsize]
read.wbal <- function(fname="M2.BAL") {
if (length(readLines(fname)) > 34 ) {
  suppressWarnings(rechdeep <- as.numeric(read.table(file=fname,skip=34,header=FALSE,nrows=
  1,colClasses=c("NULL","NULL","numeric"),fill=TRUE)))
  suppressWarnings(cgordo <- as.numeric(read.table(file=fname,skip=42,header=FALSE,nrows=1,
  colClasses=c("NULL","NULL","NULL","NULL","NULL","numeric"),fill=TRUE)))
  noria <- NA
  chaca <- NA

  x <- readLines(fname)
  stg <- "     Flow Budget for Zone  5 at Time Step  1 of Stress Period  1"
  n <- which(x==stg)
  L <- length(n)
  if (L > 0) noria <- read.table(file=fname,skip=n+18,header=FALSE,nrows=1,colClasses=c("NU
  LL","NULL","numeric"),fill=TRUE)

  stg <- "     Flow Budget for Zone 16 at Time Step  1 of Stress Period  1"
  n <- which(x==stg)
  L <- length(n)
  if (L > 0) chaca <- read.table(file=fname,skip=n+8,header=FALSE,nrows=1,colClasses=c("NUL
  L","NULL","numeric"),fill=TRUE)
  out <- c(rechdeep,noria,cgordo,chaca)
} else out <- rep(NA,4)
names(out) <- c("rechdeep","noria","cgordo","chaca")
return(out) }
\end{Verbatim}

\subsection{Implementation Details and Results of the Calibration\label{sec:resultsmf2005}}
\begin{enumerate}
\item Once \Verb+ParamFiles.txt+ and \Verb+ParamRanges.txt+ files have been created, they need to be stored in the \Verb+./PSO.in+ directory within the folder containing the main MF2005 model files, which for this tutorial corresponds to \Verb+./MF2005+.

\item Several auxiliary files (described below) are included in \Verb+./MF2005+:

\begin{Verbatim}[frame=single,label=Auxiliary Files in MF2005,fontsize=\small]
hydroPSO-MF2005.R -> Main R script to run hydroPSO
lik_gauss.txt -> ASCII file containing the likelihood value
pre_param.txt -> ASCII file containing the updated parameters
TOY_LPF_M2.txt -> Template for the LPF package used by preproc
TOY_RCH_M2.txt -> Template for the RCH package used by preproc
\end{Verbatim}

\item The setup for the problem as well as all the options implemented to calibrate the groundwater flow model are defined in the \Verb+hydroPSO-MF2005.R+ script. By default all results from \emph{hydroPSO} are saved into the \Verb+PSO.out+ folder, however, this can be redefined by using the \Verb+drty.out+ argument.

\begin{Verbatim}[frame=single,label=hydroPSO-MF2005.R,fontsize=\scriptsize]
####################################################################################
## Example to interface MODFLOW2005 and ZONE BUDGET with hydroPSO. This script     #
## allows hydroPSO to take control of the execution of MODFLOW2005 and ZONEBUDGET  #
## through the definition of a batch file (run_me.bat) and a series of simple I/O R#
## scripts                                                                         #
##                                                                                 #
## Part of the hydroPSO R package                                                  #
## http://www.rforge.net/hydroPSO/ http://cran.r-project.org/web/packages/hydroPSO #
## Copyright 2011-2012 Mauricio Zambrano-Bigiarini & Rodrigo Rojas                 #
## Distributed under GPL 2 or later                                                #
##                                                                                 #
## Created by Mauricio Zambrano-Bigiarini and Rodrigo Rojas. 26-Oct-2011           #
## Last saved: 13-Feb-2012                                                         #
####################################################################################

###Loading required libraries
library(hydroPSO)
library(hydroTSM)
library(hydroGOF)

###Definition of working directory: input, output and model files paths
model.drty <- "~/MF2005"
setwd(model.drty )                        

###Customized I/O functions (R scripts) to interface MF2005 with hydroPSO
source("read.hobs.R")
source("read.hsim.R")
source("read.wbal.R")
source("read.lik.R")

###Goodness-of-fit, either customized or pre-defined from hydroGOF
gof.FUN <- "read.lik"
gof.FUN.args <- list()

###Getting the OBSERVATIONS (not strictly necessary for this example)
obs.fname <- "M2.HOB"
obs.fname <- paste(file.path(model.drty),"/",obs.fname,sep="")
obs <- read.hobs(fname=obs.fname)

###MAIN model function
model.FUN.args=list(
   model.drty=model.drty,
   param.files=paste(model.drty,"/PSO.in/ParamFiles.txt",sep=""),
   exe.fname="run_me.bat",
   ###Function for reading the simulated equivalents
   out.FUN="read.hsim",
   out.FUN.args=list(
      fname="M2.LST",
      nobs=42),
  ###Function assessing the simulated equivalents against the observations 
  gof.FUN=gof.FUN,
  gof.FUN.args=gof.FUN.args,
  obs=obs
) ###END model.FUN.args

###MAIN PSO ALGORITHM
###For hydroPSO fine-tuning parameters, see Zambrano-Bigiarini and Rojas,2012
set.seed(1111)
hydroPSO(
   fn="hydromod",
   model.FUN="hydromod",
   model.FUN.args=model.FUN.args,
   method="pso",
   control=list(
      MinMax="max",
      npart=70,
      maxit=3000,
      reltol=1e-10,
      use.IW=TRUE,IW.type="linear",IW.w=1/(2*log(2)),IW.exp=1,
      use.TVc1=TRUE,TVc1.type="non-linear",TVc1.rng=c(1.28,1.05),TVc1.exp=1.5,
      drty.out="PSO.70p3000i.rand_TVc1_TVlambda.out",
      REPORT=50
   ) ###END control options
) ###END MAIN hydroPSO ALGORITHM
\end{Verbatim}

In the \Verb+hydroPSO-MF2005.R+ script we use \Verb+read.hobs.R+ to read groundwater head observations from M2.HOB, \Verb+read.hsim.R+ to read simulated equivalents and calculate a likelihood measure, \Verb+read.wbal.R+ to read groundwater balance components defined in the \Verb+M2.ZON+ file, and \Verb+read.lik.R+ to read the one-line ASCII file containing the likelihood measure. When a model code other than pre-defined test functions coded in \emph{hydroPSO} is used, the \Verb+fn+ argument \textbf{must} take the value \Verb+hydromod+. The latter will indicate \emph{hydroPSO} to expect for external files containing the model executable(s), input(s) and output files. We use the PSO algorithm (\Verb+method="pso"+) to maximize (\Verb+MinMax="max"+) the likelihood calculated by \Verb+read.hsim.R+. For that purpose, we employ a swarm of 70 particles (\Verb+npart=70+) and a maximum number of iterations equals to 3000 (\Verb+maxit=3000+). A constant (\Verb+IW.type="linear"+) inertia weight (\Verb+use.IW=TRUE+) value of $1/(2*log(2))$ (\Verb+IW.w+), a non-linear time-variant cognition coefficient ($c_1$) between [1.28,1.05] with exponent (\Verb+TVc1.exp=1.5+), and a linear (\Verb+TVlambda.type="linear"+) time-variant lambda factor (velocity clamping factor) (\Verb+use.TVlambda=TRUE+) between [1.0,0.5] are used for fine-tuning the algorithm. As model arguments we define \Verb+run_me.bat+ as the main code running the (sequence of) model(s) together with the main model outputs (\Verb+out.FUN="read.hsim"+) and the likelihood of that particular parameter set (\Verb+gof.FUN="read.lik"+). Finally, we save results in folder \Verb+PSO.70p3000i.rand_TVc1_TVlambda.out+.

\item Here, we illustrate the use of individual \emph{hydroPSO} ``reading'' and ``plotting'' functions to obtain customized graphs. First, we set up the corresponding directory with the results of the calibration:

<<eval=FALSE>>=
setwd("~/MF2005/PSO.70p3000i.rand_Tvc1_TVlambda.out")
@

\item Plotting the evolution of the global optimum:
<<eval=FALSE>>=
read_convergence(do.png=TRUE)
@

Figure~\ref{fig:convmeas-mf2005} shows the evolution of the Gaussian likelihood (customized goodness-of-fit measure) as a function of the number of iterations. In general, we see that there is an initial exploratory phase of ca. 500 iterations where significant improvements in the Gbest are found. After iteration nr. 1000, Gbest stabilizes and the NSR seems to reduce oscillation converging toward an attraction zone.

\item Plotting the evolution of the 30 parameters. First, we read the file \Verb+Particles.txt+ and then we call function \Verb+plot_ParamsPerIter+ for plotting:

<<eval=FALSE>>=
parts <- read_params(file="Particles.txt",param.cols=
                     4:33,plot=FALSE)
plot_ParamsPerIter(parts[["params"]])
@

Figure~\ref{fig:paramsperrun-mf2005} shows the result from the previous command lines. In this figure we see the evolution of the parameters of M2 as a function of the number of model evaluations (i.e. 70 particles $\times$ 3000 iterations). We see that several parameters show a relatively insensitive behaviour (e.g. HK\_6, HK\_10-15, HK\_21, R\_CHN, R\_TRANSP, R\_EVTR, R\_EXTD), whereas others show a clear zone of attraction. These results are in full agreement with the findings by \citet{rojas2010a}.

\item From the previous item it is clear that not all parameters are sensitive. So, here we plot sensitive parameters \underline{only} using the options of the \Verb+plot_results()+ \emph{hydroPSO} function:

<<eval=FALSE>>=
plot_results(drty.out=getwd(),MinMax="max",do.png=TRUE,
             param.names=c("HK_2","R_CHS","R_NOR","HK_19",
             "HK_16","R_RECH","R_BSMNT","R_CHN","R_TRANSP",
             "R_EVTR","R_EXTD","HK_1"))
@

This command line will produce several figures summarizing the results of the calibration for M2 (see, e.g., Section~\ref{sec:calibswat2005}). Figure~\ref{fig:dottyplots-mf2005} shows dotty-plots for the subset of sensitive parameters identified in Figure~\ref{fig:paramsperrun-mf2005}. Here, we see clear zones of attraction for some parameters (e.g. HK\_2, R\_CHS, and R\_RECH), whereas others show slightly sensitive (non-symmetric) likelihood response surfaces. Figure~\ref{fig:3Ddottyplots-mf2005}, in turn, shows (projected) 2D dotty plots among parameters highlighting non-linear interactions.

Figure~\ref{fig:ecdfs-mf2005} shows the ECDs for the sensitive parameters of M2, where the most likely parameter value is highlighted. Finally, Figure~\ref{fig:simvsobs_corr-mf2005} shows a good correspondence between the best simulated and the observed groundwater heads. 

\item At the same time, it is possible to analyse the results defining a ``behavioural'' threshold for the full set of simulated parameters. Here, we select all simulations with a Gaussian Likelihood greater than 3.8$\times10^{-2}$:

<<eval=FALSE>>=
plot_results(drty.out=getwd(),MinMax="max",do.png=TRUE,
             param.names=c("HK_2","R_CHS","R_NOR","HK_19",
             "HK_16","R_RECH","R_BSMNT","R_CHN","R_TRANSP",
             "R_EVTR","R_EXTD","HK_1"),beh.thr=3.8e-2)
@

Figures~\ref{fig:simvsobs_quant1-mf2005-038} and~\ref{fig:simvsobs_quant2-mf2005-038} show the full ECDFs for the simulated groundwater heads at 42 observation wells, highlighting the groundwater head observations and the percentage bias for the quantile 50. Figure~\ref{fig:3Ddottyplots-mf2005-038} show the resulting plots for the (projected) 2D interaction among parameters, where a clearer picture of the non-linear interactions for the zone of attraction can be seen for several parameters (e.g. R\_RECH vs. R\_NOR and R\_RECH vs. HK\_2). At the same time, Figure~\ref{fig:ecdfs-mf2005-038} shows the resulting ECDFs for a behavioural threshold of 3.8$\times10^{-2}$.

\end{enumerate}

\clearpage

\begin{sidewaysfigure}[!ht]
	\centering
	\noindent\includegraphics[width=\textwidth]{./figures/MF2005/ConvergenceMeasures.png} 
	\caption{Evolution of the Global Optimum (GOptim) and the Normalized Swarm Radius (NSR) versus iteration number for the calibration of the Ega headwater catchment.}
	\label{fig:convmeas-mf2005}
\end{sidewaysfigure}

\clearpage

\begin{sidewaysfigure}[!ht]
	\centering
	\noindent\includegraphics[width=\textwidth]{./figures/MF2005/Params_ValuesPerRun.png} 
	\caption{Convergence of the different MF2005 parameters as a function of the iteration number.}
	\label{fig:paramsperrun-mf2005}
\end{sidewaysfigure}

\clearpage

\begin{sidewaysfigure}[!ht]
	\centering
	\noindent\includegraphics[width=\textwidth]{./figures/MF2005/Params_DottyPlots.png} 
	\caption{Dotty-plots for the sensitive parameters obtained from Figure~\ref{fig:paramsperrun-mf2005} for M2. Vertical and horizontal coloured lines show the location of the highest goodness-of-fit value (Gaussian Likelihood).}
	\label{fig:dottyplots-mf2005}
\end{sidewaysfigure}

\clearpage

\begin{sidewaysfigure}[!ht!]
	\centering
	\noindent\includegraphics[width=\textwidth]{./figures/MF2005/Params_dp3d.png} 
	\caption{2-dimensional projected dotty-plots highlighting the interaction among the first seven sensitive parameters obtained from Figure~\ref{fig:paramsperrun-mf2005} for M2.}
	\label{fig:3Ddottyplots-mf2005}
\end{sidewaysfigure}

\clearpage

\begin{sidewaysfigure}[!ht]
	\centering
	\noindent\includegraphics[width=\textwidth]{./figures/MF2005/Params_ECDFs.png} 
	\caption{Empirical Cumulative Distribution Functions (ECDFs) for the sensitive parameters obtained from Figure~\ref{fig:paramsperrun-mf2005} for M2. Vertical and horizontal grey dashed-line indicate the location of a user-defined percentile.}
	\label{fig:ecdfs-mf2005}
\end{sidewaysfigure}

\clearpage

\begin{sidewaysfigure}[!ht]
	\centering
	\noindent\includegraphics[width=0.7\textwidth]{./figures/MF2005/ModelOut_BestSim_vs_Obs.png} 
	\caption{Scatter plot of best simulated versus observed groundwater heads at 42 observation wells for M2.}
	\label{fig:simvsobs_corr-mf2005}
\end{sidewaysfigure}

\clearpage

\begin{sidewaysfigure}[!ht]
	\centering
	\noindent\includegraphics[width=\textwidth]{./figures/MF2005/ModelOut_Quantiles-038.png} 
	\caption{ECDFs for groundwater heads at 42 observation wells for M2. Vertical dashed-line represents the observed value.}
	\label{fig:simvsobs_quant1-mf2005-038}
\end{sidewaysfigure}

\clearpage

\begin{sidewaysfigure}[!ht]
	\centering
	\noindent\includegraphics[width=\textwidth]{./figures/MF2005/ModelOut_Quantiles2-038.png} 
	\caption{ECDFs for groundwater heads at 42 observation wells for M2. Vertical dashed-line represents the observed value.}
	\label{fig:simvsobs_quant2-mf2005-038}
\end{sidewaysfigure}

\clearpage

\begin{sidewaysfigure}[!ht]
	\centering
	\noindent\includegraphics[width=\textwidth]{./figures/MF2005/Params_dp3d-038.png} 
	\caption{Idem as Figure~\ref{fig:3Ddottyplots-mf2005} with a ``behavioural'' threshold of 3.8$\times10^{-2}$.}
	\label{fig:3Ddottyplots-mf2005-038}
\end{sidewaysfigure}

\clearpage

\begin{sidewaysfigure}[!ht]
	\centering
	\noindent\includegraphics[width=\textwidth]{./figures/MF2005/Params_ECDFs-038.png} 
	\caption{Idem as Figure~\ref{fig:ecdfs-mf2005} with a ``behavioural'' threshold of 3.8$\times10^{-2}$.}
	\label{fig:ecdfs-mf2005-038}
\end{sidewaysfigure}

\clearpage

\section{Closing Remarks}
\begin{enumerate}
\item This tutorial aimed at providing a general overview of the capabilities of the \emph{hydroPSO} R package. In particular, we illustrated how to calibrate two model codes commonly used in hydrology-related applications, SWAT-2005 and MODFLOW-2005. Given the flexibility of \emph{hydroPSO}, we believe this calibration/optimisation engine can be applied to a wider range of environmental models requiring some form of parameter estimation.

\item The version of \emph{hydroPSO} used in this tutorial does not take advantage of multi-core machines nor from parallelized platforms. We hope in the next future to add parallel capabilities to \emph{hydroPSO} to benefit from modern architectures and alleviate the computational burden.

\item In \emph{hydroPSO} we consider \underline{only} single-objective functions for optimisation. Again, we hope in the next future to include multi-objective functionalities to the main algorithm.

\item Finally, investigation on improvements to the canonical PSO algorithm is one of the most dynamic and active research areas in  Particle Swarm literature. Therefore, we are particularly interested in constantly updating the \emph{hydroPSO} package according to the most relevant innovations in this research area.

\end{enumerate}


\clearpage
%##################################
This tutorial was built under: 

<<echo=FALSE>>=
paste("hydroPSO", sessionInfo()$otherPkgs$hydroPSO$Version)
sessionInfo()$R.version$version.string 
sessionInfo()$platform
@

\clearpage

\singlespacing
\addcontentsline{toc}{section}{References}
\bibliographystyle{agufull08}
\bibliography{references}

<<wrapup, echo=FALSE>>=
setwd(CUR_WD)
@ 
% The previous 3 lines ware neccessary to avoid the following error: "Error in driver$finish(drobj) :  the output file 'MyDocument.tex' has disappeared". From: http://r.789695.n4.nabble.com/Sweave-problem-after-R-update-version-td4566044.html

\end{document}
